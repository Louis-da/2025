# 项目规则（马斯克标准·可执行版）

第一性原则（决策过滤器）
- 必须可测量：任何规则最终可转化为可观测指标或自动化校验
- 默认删除：能删就删；删错再加回；每个迭代至少删一项
- 以用户体验为最高优先：P95、成功率、回滚时间，是评估一切技术选择的唯一准绳

一、接口与调用规范（最小必需集）
1) 入参：所有读写请求必须携带 orgId（Header X-Org-Id 或 body.orgId）；缺失直接 400
2) 租户隔离：数据库字段统一为 org_id；查询需包含 { org_id: orgId }
3) 状态过滤：列表类查询必须包含 { status: 'active' | 1 }
4) 幂等：写操作提供幂等键（userId+orgId+业务键）；重复提交返回相同结果
5) 响应：统一结构 { code, message, data, requestId }
6) 失败语义：4xx 为调用方问题，5xx 为服务端问题；所有 5xx 自动打点错误日志

二、前后端协作约定
- 登录后：orgId 必须写入本地存储（miniprogram.utils.session），并在每次请求透传
- Loading 规范：showLoading 与 hideLoading 必须配对；catch/finally 分支兜底关闭
- 空态可解释：列表为空时必须展示“按 orgId 与状态过滤后的空态”说明与重试入口
- 版本前向兼容：新增字段一律可选；接口变更先灰度，旧参数保留两版

三、安全与权限（最小集）
- 最小权限：仅授予当前功能所需云权限；禁止泛读写
- 密钥：不得写入仓库/日志；使用环境变量与密钥服务；本地用 .env.*
- 审计：关键操作（登录、下发、收回）必须记录 requestId、userId、orgId、耗时、结果

四、发布与回滚
- 小步快跑：以功能旗标控制开关；每周≥2次发布
- 一键回滚：云函数与静态托管均保留上一个稳定版本；回滚目标≤15分钟
- 变更说明：PR 模板必须包含“删除了什么、如何验证、是否需要数据迁移”

五、测试与验收（可执行清单）
- 单元：api/utils 至少覆盖参数校验与租户隔离
- 集成：登录→工厂列表→下发/收回 三条关键路径 P95、成功率达标
- E2E：首屏 TTI P95 ≤ 800ms；下发/收回成功率≥99.9%；异常用例可解释

六、监控与告警
- 指标：请求量、成功率、P95、错误率（4xx/5xx 分开）
- 告警：Sev1 触发条件——成功率跌破99.5%或P95>目标150ms；自动@责任人
- 事后复盘：72小时内提交根因、长期修复、是否可通过删减简化避免

七、排障优先级（遇到“列表为空/流程失败”按此序）
1) 前端：本地存储是否存在 orgId；请求是否携带 orgId；Loading 是否兜底关闭
2) 数据：factories 是否存在 org_id=orgId 的 active/1 记录
3) 云函数：getFactories 是否以 org_id+status 过滤，是否返回统一结构
4) 版本：是否刚部署；可否一键回滚上一个稳定版本
5) 日志：按 requestId 检索从入口到数据库的完整链路

八、删减清单（保持简洁）
- 文档：仅保留 docs/README.md 与 docs/rules.md
- 代码：移除未使用的调试页面/脚本；凡新增脚本需注明删除条件
- 配置：去除未使用环境与密钥项；引入即文档化，废弃即删除

附：接口示例（统一结构）
- 请求：{ action: 'getFactories', orgId }
- 响应：{ code: 0, message: 'ok', data: { list: Factory[] }, requestId }

附：版本与兼容策略
- 破坏性变更：必须提供迁移与回滚脚本；默认灰度、逐步提升流量
- 字段策略：新增字段默认可选；删除字段至少保留两版兼容层