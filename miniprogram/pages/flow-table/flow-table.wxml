<view class="container">
  <!-- 简洁筛选区域 -->
  <view class="filter-section">
    <!-- 货品选择 -->
    <view class="filter-item">
      <view class="product-dropdown-container">
        <view class="product-search-input-wrapper">
          <input 
            class="filter-input {{selectedProduct ? 'has-value' : ''}}" 
            placeholder="选择货品"
            value="{{productInputValue}}"
            bindinput="onProductSearch"
            bindtap="showProductDropdown"
            bindfocus="onProductInputFocus"
            bindblur="hideProductDropdownWithDelay"
            confirm-type="search"
          />
        </view>
        <!-- 货品下拉列表 -->
        <view class="product-dropdown {{showProductDropdown ? 'show' : ''}}" catchtap="">
          <scroll-view class="dropdown-scroll" scroll-y="true">
            <view wx:if="{{filteredProducts.length === 0}}" class="dropdown-empty">
              <view class="empty-icon">📦</view>
              <view class="empty-text">未找到相关货品</view>
            </view>
            <view wx:else class="product-dropdown-list">
              <!-- 全部货品选项 -->
              <view 
                class="product-dropdown-item {{!selectedProduct ? 'selected' : ''}}" 
                catchtap="selectProductFromDropdown" 
                data-product=""
              >
                <view class="product-info">
                  <view class="product-name">全部货品</view>
                  <view class="product-details">
                    <text class="product-subtitle">查看所有货品的流水信息</text>
                  </view>
                </view>
                <view class="check-mark" wx:if="{{!selectedProduct}}">✓</view>
              </view>
              <!-- 具体货品选项 -->
              <view 
                class="product-dropdown-item {{selectedProduct && selectedProduct === item.name ? 'selected' : ''}}" 
                wx:for="{{filteredProducts}}" 
                wx:key="id" 
                catchtap="selectProductFromDropdown" 
                data-product="{{item}}"
              >
                <view class="product-info">
                  <view class="product-name">{{item.productNo || item.code}}</view>
                  <view class="product-details" wx:if="{{item.name || item.process}}">
                    <text class="product-subtitle" wx:if="{{item.name}}">{{item.name}}</text>
                    <text class="product-process" wx:if="{{item.process}}">{{item.process}}</text>
                  </view>
                </view>
                <view class="check-mark" wx:if="{{selectedProduct && selectedProduct === item.name}}">✓</view>
              </view>
            </view>
          </scroll-view>
        </view>
      </view>
    </view>
    
    <!-- 工厂选择 -->
    <view class="filter-item">
      <view class="factory-dropdown-container">
        <view class="factory-search-input-wrapper">
          <input 
            class="filter-input {{selectedFactory ? 'has-value' : ''}}" 
            placeholder="选择工厂"
            value="{{factorySearchKeyword}}"
            bindinput="onFactorySearch"
            bindtap="showFactoryDropdown"
            bindfocus="showFactoryDropdown"
            bindblur="hideFactoryDropdownWithDelay"
            confirm-type="search"
          />
        </view>
        <!-- 苹果简约风下拉列表 -->
        <view class="factory-dropdown {{showFactoryDropdown ? 'show' : ''}}" wx:if="{{showFactoryDropdown}}">
          <scroll-view class="dropdown-scroll" scroll-y="true">
            <view wx:if="{{filteredFactories.length === 0}}" class="dropdown-empty">
              <view class="empty-icon">🏭</view>
              <view class="empty-text">未找到相关工厂</view>
            </view>
            <view wx:else class="factory-dropdown-list">
              <view 
                class="factory-dropdown-item {{selectedFactory === item.name ? 'selected' : ''}}" 
                wx:for="{{filteredFactories}}" 
                wx:key="id" 
                catchtap="selectFactoryFromDropdown" 
                data-factory="{{item}}"
              >
                <view class="factory-info">
                  <view class="factory-name">{{item.name}}</view>
                  <view class="factory-details" wx:if="{{item.phone || item.address}}">
                    <text class="factory-phone" wx:if="{{item.phone}}">📞 {{item.phone}}</text>
                    <text class="factory-address" wx:if="{{item.address}}">📍 {{item.address}}</text>
                  </view>
                </view>
                <view class="check-mark" wx:if="{{selectedFactory === item.name}}">✓</view>
              </view>
            </view>
          </scroll-view>
        </view>
      </view>
    </view>
    
    <!-- 日期范围 -->
    <view class="filter-item date-range">
      <picker mode="date" value="{{dateRange.start}}" bindchange="selectStartDate" class="date-picker">
        <view class="filter-input">
          <text>{{dateRange.start || '开始日期'}}</text>
        </view>
      </picker>
      <text class="date-separator">至</text>
      <picker mode="date" value="{{dateRange.end}}" bindchange="selectEndDate" class="date-picker">
        <view class="filter-input">
          <text>{{dateRange.end || '结束日期'}}</text>
        </view>
      </picker>
    </view>
    
    <!-- 操作按钮 -->
    <view class="filter-actions">
      <button class="query-btn" bindtap="onQueryTap">查询</button>
      <button class="clear-btn" bindtap="clearAllFilters">重置</button>
    </view>
  </view>
  
  <!-- 活跃筛选标签 -->
  <view wx:if="{{hasFilter}}" class="active-filters">
    <view class="filter-tag" wx:if="{{selectedProduct}}">
      <text>货品: {{selectedProduct}}</text>
      <view class="tag-close" data-type="product" bindtap="clearFilter">×</view>
    </view>
    <view class="filter-tag" wx:if="{{selectedFactory}}">
      <text>工厂: {{selectedFactory}}</text>
      <view class="tag-close" data-type="factory" bindtap="clearFilter">×</view>
    </view>
    <view class="filter-tag" wx:if="{{dateRange.start}}">
      <text>{{dateRange.start}} 至 {{dateRange.end || '今天'}}</text>
      <view class="tag-close" data-type="date" bindtap="clearFilter">×</view>
    </view>
  </view>

  <!-- 流水记录列表 -->
  <view wx:if="{{formattedDetailedRecords.length > 0}}" class="records-list">
    <view class="record-card" wx:for="{{formattedDetailedRecords}}" wx:key="id">
      <view class="card-header">
        <view class="header-left">
          <view class="record-type {{item.type === 'send' ? 'send-type' : 'receive-type'}}">
            {{item.typeText}}
          </view>
          <view class="order-no">{{item.order_no || '-'}}</view>
        </view>
        <view class="record-date">{{item.date}}</view>
      </view>
      
      <view class="card-content">
        <!-- 第一行：货号、名称、工序、工厂 -->
        <view class="content-row">
          <view class="field-group-quarter">
            <text class="field-label">货号</text>
            <text class="field-value">{{item.product_no}}</text>
          </view>
          <view class="field-group-quarter">
            <text class="field-label">名称</text>
            <text class="field-value">{{item.product_name || '-'}}</text>
          </view>
          <view class="field-group-quarter">
            <text class="field-label">工序</text>
            <text class="field-value">{{item.process_name}}</text>
          </view>
          <view class="field-group-quarter">
            <text class="field-label">工厂</text>
            <text class="field-value">{{item.factory_name}}</text>
          </view>
        </view>
        
        <!-- 第二行：颜色、尺码、数量、重量 -->
        <view class="content-row">
          <view class="field-group-quarter">
            <text class="field-label">颜色</text>
            <text class="field-value">{{item.color || '-'}}</text>
          </view>
          <view class="field-group-quarter">
            <text class="field-label">尺码</text>
            <text class="field-value">{{item.size || '-'}}</text>
          </view>
          <view class="field-group-quarter">
            <text class="field-label">数量</text>
            <text class="field-value">{{item.quantity}}打</text>
          </view>
          <view class="field-group-quarter">
            <text class="field-label">重量</text>
            <text class="field-value">{{item.weight}}kg</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view wx:if="{{formattedDetailedRecords.length === 0 && !hasFilter}}" class="empty-state">
    <view class="empty-icon">📋</view>
    <text class="empty-title">暂无流水记录</text>
    <text class="empty-desc">当前没有任何收发流水数据</text>
  </view>

  <view wx:if="{{formattedDetailedRecords.length === 0 && hasFilter}}" class="empty-state">
    <view class="empty-icon">🔍</view>
    <text class="empty-title">未找到匹配记录</text>
    <text class="empty-desc">请调整筛选条件重新查询</text>
  </view>
</view>

