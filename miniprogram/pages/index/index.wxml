<!--miniprogram/pages/index/index.wxml-->
<view class="page-bg">
  <!-- ä»Šæ—¥æ•°æ® -->
  <view class="card stats-card">
    <view class="stats-title">ä»Šæ—¥æ•°æ®</view>
    <view class="stats-row">
      <view class="stats-item">
        <view class="stats-label">å‘å‡º</view>
        <view class="stats-value">{{todaySendTotalWeight}}kg</view>
        <view class="stats-count">{{todaySendOrderCount}}å•</view>
      </view>
      <view class="stats-item">
        <view class="stats-label">æ”¶å›</view>
        <view class="stats-value">{{todayReceiveTotalWeight}}kg</view>
        <view class="stats-count">{{todayReceiveOrderCount}}å•</view>
      </view>
    </view>
  </view>

  <!-- è®¢å•ç±»å‹åˆ‡æ¢ -->
  <view class="card tabs-card">
    <view class="tabs">
      <view class="tab {{activeTab === 'sent' ? 'active' : ''}}" bindtap="switchTab" data-tab="sent">å‘å‡ºå•</view>
      <view class="tab {{activeTab === 'received' ? 'active' : ''}}" bindtap="switchTab" data-tab="received">æ”¶å›å•</view>
    </view>
  </view>

  <!-- æœç´¢æ  -->
  <!-- <view class="card search-card">
    <view class="search-container">
      <view class="search-box">
        <image class="search-icon" src="/images/icons/search-icon.png" mode="aspectFit"/>
        <input class="search-input" placeholder="æœç´¢å•å·ã€å·¥å‚" />
      </view>
    </view>
  </view> -->

  <!-- äº‘åŠ©ç†å¡ç‰‡ -->
  <view class="card ai-assistant-card">
    <view class="ai-assistant-container" bindtap="navigateToAIFlowTable">
      <view class="ai-assistant-content">
        <view class="ai-assistant-icon">ğŸ¤–</view>
        <view class="ai-assistant-text">
          <view class="ai-assistant-title">äº‘åŠ©ç†</view>
          <view class="ai-assistant-desc">ç»Ÿè®¡åˆ†ææ”¶å‘æµæ°´ï¼Œå‘ç°å¼‚å¸¸å’Œè¶‹åŠ¿</view>
        </view>
        <view class="ai-assistant-arrow">â†’</view>
      </view>
      <view class="ai-assistant-features">
        <view class="feature-item">
          <text class="feature-icon">âš¡</text>
          <text class="feature-text">å¼‚å¸¸æ£€æµ‹</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">ğŸ“Š</text>
          <text class="feature-text">è¶‹åŠ¿åˆ†æ</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">ğŸ’¡</text>
          <text class="feature-text">æ•°æ®å»ºè®®</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åˆæ ¼æ’è¡Œå¡ç‰‡ -->
  <view wx:if="{{showAIHelperText}}" class="card ai-helper-container">
    <view class="section-title">
      <view class="title-main">
        <text class="title-icon">ğŸ†</text>
        <text class="title-text">åˆæ ¼æ’è¡Œ</text>
      </view>
      <!-- æ—¶é—´ç­›é€‰æŒ‰é’®ç»„ -->
      <view class="time-filter-container">
        <view class="time-filter-buttons">
          <text class="time-filter-btn {{qualifiedTimeFilterType === 'today' ? 'active' : ''}}" bindtap="selectQualifiedTimeFilter" data-type="today">æœ¬æ—¥</text>
          <text class="time-filter-btn {{qualifiedTimeFilterType === 'week' ? 'active' : ''}}" bindtap="selectQualifiedTimeFilter" data-type="week">æœ¬å‘¨</text>
          <text class="time-filter-btn {{qualifiedTimeFilterType === 'month' ? 'active' : ''}}" bindtap="selectQualifiedTimeFilter" data-type="month">æœ¬æœˆ</text>
          <text class="time-filter-btn {{qualifiedTimeFilterType === 'year' ? 'active' : ''}}" bindtap="selectQualifiedTimeFilter" data-type="year">æœ¬å¹´</text>
          <text class="time-filter-btn custom {{qualifiedTimeFilterType === 'custom' ? 'active' : ''}}" bindtap="selectQualifiedTimeFilter" data-type="custom">è‡ªå®šä¹‰</text>
        </view>
      </view>
      <view class="bottom-info">
        <text class="count-text" wx:if="{{qualifiedLossRanking.length > 0}}">{{qualifiedLossRanking.length}}</text>
        <text class="rule-text">æŸè€—ç‡æ§åˆ¶åœ¨Â±2%èŒƒå›´å†…çš„ä¼˜ç§€è´§å“</text>
      </view>
    </view>
    
    <!-- æœ‰æ•°æ®æ—¶æ˜¾ç¤ºåˆ—è¡¨ -->
    <view wx:if="{{qualifiedLossRanking.length > 0}}">
      <!-- åˆæ ¼æ’è¡Œåˆ—è¡¨ -->
      <view class="qualified-ranking-list">
        <view wx:for="{{qualifiedLossRanking}}" wx:key="id" class="qualified-ranking-item">
          <view class="rank-badge rank-{{item.rank <= 3 ? item.rank : 'other'}}">
            <text wx:if="{{item.rank === 1}}">ğŸ¥‡</text>
            <text wx:elif="{{item.rank === 2}}">ğŸ¥ˆ</text>
            <text wx:elif="{{item.rank === 3}}">ğŸ¥‰</text>
            <text wx:else>{{item.rank}}</text>
          </view>
          
          <!-- è´§å“å›¾ç‰‡ -->
          <view class="product-image-container">
            <image 
              wx:if="{{item.productImage}}" 
              src="{{item.productImage}}" 
              class="product-image"
              mode="aspectFill"
              lazy-load="true"
              binderror="onImageError"
              data-index="{{index}}"
            />
            <view wx:else class="product-image-placeholder">
              <text class="placeholder-text">æš‚æ— å›¾ç‰‡</text>
            </view>
          </view>
          
          <view class="item-content">
            <view class="product-info">
              <text class="product-no">{{item.productNo}}</text>
              <text class="product-name">{{item.productName || item.name}}</text>
              <text class="metric-value qualified">{{item.lossRate}}%</text>
            </view>
            
            <view class="metrics">
              <text class="metric-item">å‘å‡º: {{item.sendWeight}}kg</text>
              <text class="metric-item">æ”¶å›: {{item.receiveWeight}}kg</text>
            </view>
            
            <view wx:if="{{item.factoryCount > 0}}" class="factory-bottom-row">
              <text class="factory-count">{{item.factoryCount}}ä¸ªå·¥å‚</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:elif="{{qualifiedRankingLoading}}" class="loading-container">
      <view class="loading-icon">â³</view>
      <view class="loading-text">æ­£åœ¨è·å–åˆæ ¼æ’è¡Œæ•°æ®...</view>
    </view>
    
    <!-- æ— æ•°æ®æ—¶æ˜¾ç¤ºæç¤º -->
    <view wx:else class="no-data-container">
      <view class="no-data-icon">ğŸ“Š</view>
      <view class="no-data-text">æš‚æ— åˆæ ¼æ•°æ®</view>
      <view class="no-data-desc">è¿˜æ²¡æœ‰æŸè€—ç‡åˆæ ¼çš„è®°å½•ï¼Œè¯·ç»§ç»­åŠªåŠ›ï¼</view>
    </view>
  </view>

  <!-- è®¢å•åˆ—è¡¨ -->
  <view class="card order-list-card">
    <scroll-view scroll-y class="order-list" wx:if="{{ !showAIHelperText }}">
      <!-- å‘å‡ºå•åˆ—è¡¨ -->
      <block wx:if="{{activeTab === 'sent'}}">
        <view class="order-item-card {{item.isCancelled ? 'cancelled-order' : ''}}" wx:for="{{sendList}}" wx:key="id">
          <view class="order-header">
            <text class="order-id">#{{item.orderNo}}</text>
            <text class="order-factory">{{item.factoryName}}</text>
            <text class="order-status {{item.isCancelled ? 'status-cancelled' : ''}}">{{item.statusText}}</text>
          </view>
          <view class="order-details">
            <view class="detail-pair"><text class="label">é‡é‡</text><text class="value">{{item.weight}}kg</text></view>
            <view class="detail-pair"><text class="label">æ•°é‡</text><text class="value">{{item.quantity}}æ‰“</text></view>
          </view>
          <view class="order-footer">
            <text class="order-creator">åˆ¶å•: {{item.staff}}</text>
            <text class="order-date">{{item.date}}</text>
          </view>
        </view>
      </block>
      
      <!-- æ”¶å›å•åˆ—è¡¨ -->
      <block wx:if="{{activeTab === 'received'}}">
        <view class="order-item-card {{item.isCancelled ? 'cancelled-order' : ''}}" wx:for="{{receiveList}}" wx:key="id">
          <view class="order-header">
            <text class="order-id">#{{item.orderNo}}</text>
            <text class="order-factory">{{item.factoryName}}</text>
            <text class="order-status {{item.isCancelled ? 'status-cancelled' : ''}}">{{item.statusText}}</text>
          </view>
          <view class="order-details">
            <view class="detail-pair"><text class="label">é‡é‡</text><text class="value">{{item.weight}}kg</text></view>
            <view class="detail-pair"><text class="label">æ•°é‡</text><text class="value">{{item.quantity}}æ‰“</text></view>
          </view>
          <view class="order-footer">
            <text class="order-creator">åˆ¶å•: {{item.staff}}</text>
            <text class="order-date">{{item.date}}</text>
          </view>
        </view>
      </block>
    </scroll-view>

    <!-- ç©ºçŠ¶æ€æç¤º -->
    <view class="empty-state" wx:if="{{ !showAIHelperText && sendList.length === 0 && receiveList.length === 0 }}">
      <view class="empty-icon">ğŸ“¦</view>
      <view class="empty-text">æš‚æ— è®¢å•æ•°æ®</view>
      <view class="empty-desc">ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªè®¢å•</view>
    </view>
  </view>

  <!-- æ–°å¢æŒ‰é’® -->
  <view class="add-button" bindtap="onAddOrder"></view>
</view>

<!-- è‡ªå®šä¹‰æ—¶é—´ç­›é€‰å¼¹çª— -->
<view wx:if="{{showQualifiedCustomTimeModal}}" class="modal-overlay" bindtap="hideQualifiedCustomTimeFilter">
  <view class="modal-content" catchtap="doNothing">
    <view class="modal-header">
      <text class="modal-title">è‡ªå®šä¹‰æ—¶é—´èŒƒå›´</text>
      <text class="modal-close" bindtap="hideQualifiedCustomTimeFilter">âœ•</text>
    </view>
    <view class="modal-body">
      <view class="date-picker-group">
        <view class="date-picker-item">
          <text class="date-label">å¼€å§‹æ—¥æœŸ</text>
          <picker mode="date" value="{{qualifiedCustomStartDate}}" bindchange="onQualifiedCustomStartDateChange">
            <view class="date-picker-display">
              <text class="date-text">{{qualifiedCustomStartDate || 'è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸ'}}</text>
              <text class="date-icon">ğŸ“…</text>
            </view>
          </picker>
        </view>
        <view class="date-picker-item">
          <text class="date-label">ç»“æŸæ—¥æœŸ</text>
          <picker mode="date" value="{{qualifiedCustomEndDate}}" bindchange="onQualifiedCustomEndDateChange">
            <view class="date-picker-display">
              <text class="date-text">{{qualifiedCustomEndDate || 'è¯·é€‰æ‹©ç»“æŸæ—¥æœŸ'}}</text>
              <text class="date-icon">ğŸ“…</text>
            </view>
          </picker>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <text class="modal-btn cancel" bindtap="hideQualifiedCustomTimeFilter">å–æ¶ˆ</text>
      <text class="modal-btn confirm" bindtap="confirmQualifiedCustomTimeFilter">ç¡®å®š</text>
    </view>
  </view>
</view>
