<!--miniprogram/pages/index/index.wxml-->
<view class="page-bg">
  <!-- 今日数据 -->
  <view class="card stats-card">
    <view class="stats-title">今日数据</view>
    <view class="stats-row">
      <view class="stats-item">
        <view class="stats-label">发出</view>
        <view class="stats-value">{{todaySendTotalWeight}}kg</view>
        <view class="stats-count">{{todaySendOrderCount}}单</view>
      </view>
      <view class="stats-item">
        <view class="stats-label">收回</view>
        <view class="stats-value">{{todayReceiveTotalWeight}}kg</view>
        <view class="stats-count">{{todayReceiveOrderCount}}单</view>
      </view>
    </view>
  </view>

  <!-- 订单类型切换 -->
  <view class="card tabs-card">
    <view class="tabs">
      <view class="tab {{activeTab === 'sent' ? 'active' : ''}}" bindtap="switchTab" data-tab="sent">发出单</view>
      <view class="tab {{activeTab === 'received' ? 'active' : ''}}" bindtap="switchTab" data-tab="received">收回单</view>
    </view>
  </view>

  <!-- 搜索栏 -->
  <!-- <view class="card search-card">
    <view class="search-container">
      <view class="search-box">
        <image class="search-icon" src="/images/icons/search-icon.png" mode="aspectFit"/>
        <input class="search-input" placeholder="搜索单号、工厂" />
      </view>
    </view>
  </view> -->

  <!-- 云助理卡片 -->
  <view class="card ai-assistant-card">
    <view class="ai-assistant-container" bindtap="navigateToAIFlowTable">
      <view class="ai-assistant-content">
        <view class="ai-assistant-icon">🤖</view>
        <view class="ai-assistant-text">
          <view class="ai-assistant-title">云助理</view>
          <view class="ai-assistant-desc">统计分析收发流水，发现异常和趋势</view>
        </view>
        <view class="ai-assistant-arrow">→</view>
      </view>
      <view class="ai-assistant-features">
        <view class="feature-item">
          <text class="feature-icon">⚡</text>
          <text class="feature-text">异常检测</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">📊</text>
          <text class="feature-text">趋势分析</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">💡</text>
          <text class="feature-text">数据建议</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 合格排行卡片 -->
  <view wx:if="{{showAIHelperText}}" class="card ai-helper-container">
    <view class="section-title">
      <view class="title-main">
        <text class="title-icon">🏆</text>
        <text class="title-text">合格排行</text>
      </view>
      <!-- 时间筛选按钮组 -->
      <view class="time-filter-container">
        <view class="time-filter-buttons">
          <text class="time-filter-btn {{qualifiedTimeFilterType === 'today' ? 'active' : ''}}" bindtap="selectQualifiedTimeFilter" data-type="today">本日</text>
          <text class="time-filter-btn {{qualifiedTimeFilterType === 'week' ? 'active' : ''}}" bindtap="selectQualifiedTimeFilter" data-type="week">本周</text>
          <text class="time-filter-btn {{qualifiedTimeFilterType === 'month' ? 'active' : ''}}" bindtap="selectQualifiedTimeFilter" data-type="month">本月</text>
          <text class="time-filter-btn {{qualifiedTimeFilterType === 'year' ? 'active' : ''}}" bindtap="selectQualifiedTimeFilter" data-type="year">本年</text>
          <text class="time-filter-btn custom {{qualifiedTimeFilterType === 'custom' ? 'active' : ''}}" bindtap="selectQualifiedTimeFilter" data-type="custom">自定义</text>
        </view>
      </view>
      <view class="bottom-info">
        <text class="count-text" wx:if="{{qualifiedLossRanking.length > 0}}">{{qualifiedLossRanking.length}}</text>
        <text class="rule-text">损耗率控制在±2%范围内的优秀货品</text>
      </view>
    </view>
    
    <!-- 有数据时显示列表 -->
    <view wx:if="{{qualifiedLossRanking.length > 0}}">
      <!-- 合格排行列表 -->
      <view class="qualified-ranking-list">
        <view wx:for="{{qualifiedLossRanking}}" wx:key="id" class="qualified-ranking-item">
          <view class="rank-badge rank-{{item.rank <= 3 ? item.rank : 'other'}}">
            <text wx:if="{{item.rank === 1}}">🥇</text>
            <text wx:elif="{{item.rank === 2}}">🥈</text>
            <text wx:elif="{{item.rank === 3}}">🥉</text>
            <text wx:else>{{item.rank}}</text>
          </view>
          
          <!-- 货品图片 -->
          <view class="product-image-container">
            <image 
              wx:if="{{item.productImage}}" 
              src="{{item.productImage}}" 
              class="product-image"
              mode="aspectFill"
              lazy-load="true"
              binderror="onImageError"
              data-index="{{index}}"
            />
            <view wx:else class="product-image-placeholder">
              <text class="placeholder-text">暂无图片</text>
            </view>
          </view>
          
          <view class="item-content">
            <view class="product-info">
              <text class="product-no">{{item.productNo}}</text>
              <text class="product-name">{{item.productName || item.name}}</text>
              <text class="metric-value qualified">{{item.lossRate}}%</text>
            </view>
            
            <view class="metrics">
              <text class="metric-item">发出: {{item.sendWeight}}kg</text>
              <text class="metric-item">收回: {{item.receiveWeight}}kg</text>
            </view>
            
            <view wx:if="{{item.factoryCount > 0}}" class="factory-bottom-row">
              <text class="factory-count">{{item.factoryCount}}个工厂</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 加载状态 -->
    <view wx:elif="{{qualifiedRankingLoading}}" class="loading-container">
      <view class="loading-icon">⏳</view>
      <view class="loading-text">正在获取合格排行数据...</view>
    </view>
    
    <!-- 无数据时显示提示 -->
    <view wx:else class="no-data-container">
      <view class="no-data-icon">📊</view>
      <view class="no-data-text">暂无合格数据</view>
      <view class="no-data-desc">还没有损耗率合格的记录，请继续努力！</view>
    </view>
  </view>

  <!-- 订单列表 -->
  <view class="card order-list-card">
    <scroll-view scroll-y class="order-list" wx:if="{{ !showAIHelperText }}">
      <!-- 发出单列表 -->
      <block wx:if="{{activeTab === 'sent'}}">
        <view class="order-item-card {{item.isCancelled ? 'cancelled-order' : ''}}" wx:for="{{sendList}}" wx:key="id">
          <view class="order-header">
            <text class="order-id">#{{item.orderNo}}</text>
            <text class="order-factory">{{item.factoryName}}</text>
            <text class="order-status {{item.isCancelled ? 'status-cancelled' : ''}}">{{item.statusText}}</text>
          </view>
          <view class="order-details">
            <view class="detail-pair"><text class="label">重量</text><text class="value">{{item.weight}}kg</text></view>
            <view class="detail-pair"><text class="label">数量</text><text class="value">{{item.quantity}}打</text></view>
          </view>
          <view class="order-footer">
            <text class="order-creator">制单: {{item.staff}}</text>
            <text class="order-date">{{item.date}}</text>
          </view>
        </view>
      </block>
      
      <!-- 收回单列表 -->
      <block wx:if="{{activeTab === 'received'}}">
        <view class="order-item-card {{item.isCancelled ? 'cancelled-order' : ''}}" wx:for="{{receiveList}}" wx:key="id">
          <view class="order-header">
            <text class="order-id">#{{item.orderNo}}</text>
            <text class="order-factory">{{item.factoryName}}</text>
            <text class="order-status {{item.isCancelled ? 'status-cancelled' : ''}}">{{item.statusText}}</text>
          </view>
          <view class="order-details">
            <view class="detail-pair"><text class="label">重量</text><text class="value">{{item.weight}}kg</text></view>
            <view class="detail-pair"><text class="label">数量</text><text class="value">{{item.quantity}}打</text></view>
          </view>
          <view class="order-footer">
            <text class="order-creator">制单: {{item.staff}}</text>
            <text class="order-date">{{item.date}}</text>
          </view>
        </view>
      </block>
    </scroll-view>

    <!-- 空状态提示 -->
    <view class="empty-state" wx:if="{{ !showAIHelperText && sendList.length === 0 && receiveList.length === 0 }}">
      <view class="empty-icon">📦</view>
      <view class="empty-text">暂无订单数据</view>
      <view class="empty-desc">点击右下角按钮添加第一个订单</view>
    </view>
  </view>

  <!-- 新增按钮 -->
  <view class="add-button" bindtap="onAddOrder"></view>
</view>

<!-- 自定义时间筛选弹窗 -->
<view wx:if="{{showQualifiedCustomTimeModal}}" class="modal-overlay" bindtap="hideQualifiedCustomTimeFilter">
  <view class="modal-content" catchtap="doNothing">
    <view class="modal-header">
      <text class="modal-title">自定义时间范围</text>
      <text class="modal-close" bindtap="hideQualifiedCustomTimeFilter">✕</text>
    </view>
    <view class="modal-body">
      <view class="date-picker-group">
        <view class="date-picker-item">
          <text class="date-label">开始日期</text>
          <picker mode="date" value="{{qualifiedCustomStartDate}}" bindchange="onQualifiedCustomStartDateChange">
            <view class="date-picker-display">
              <text class="date-text">{{qualifiedCustomStartDate || '请选择开始日期'}}</text>
              <text class="date-icon">📅</text>
            </view>
          </picker>
        </view>
        <view class="date-picker-item">
          <text class="date-label">结束日期</text>
          <picker mode="date" value="{{qualifiedCustomEndDate}}" bindchange="onQualifiedCustomEndDateChange">
            <view class="date-picker-display">
              <text class="date-text">{{qualifiedCustomEndDate || '请选择结束日期'}}</text>
              <text class="date-icon">📅</text>
            </view>
          </picker>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <text class="modal-btn cancel" bindtap="hideQualifiedCustomTimeFilter">取消</text>
      <text class="modal-btn confirm" bindtap="confirmQualifiedCustomTimeFilter">确定</text>
    </view>
  </view>
</view>
