<view class="apple-bg">
  <!-- ç§»é™¤æ ‡é¢˜æ¨¡å—ï¼Œé¡¶éƒ¨æ ‡é¢˜å°†ç”±å°ç¨‹åºé¡¶éƒ¨å¯¼èˆªæ æ˜¾ç¤º -->

  <!-- å·¥å‚å’Œå·¥åºä¿¡æ¯æ”¾åœ¨æœ€ä¸Šæ–¹ -->
  <view class="apple-card section info-section" wx:if="{{mode !== 'view'}}">
    <view class="form-row factory-process-row">
      <view class="form-col factory-col">
        <view class="form-label required">å·¥å‚</view>
        <picker bindchange="selectFactory" range="{{factories}}" range-key="name" disabled="{{mode === 'view'}}">
          <view class="form-value apple-input {{selectedFactory ? '' : 'placeholder'}}">
            {{selectedFactory ? selectedFactory.name : 'é€‰æ‹©å·¥å‚'}}
          </view>
        </picker>
      </view>
      <view class="form-col process-col">
        <view class="form-label required">å·¥åº</view>
        <picker bindchange="selectProcess" range="{{processes}}">
          <view class="form-value apple-input {{selectedProcess ? '' : 'placeholder'}}">
            {{selectedProcess || 'è¯·é€‰æ‹©'}}
          </view>
        </picker>
      </view>
    </view>
  </view>

  <view class="apple-card section">
    <view class="section-title">è´§å“ä¿¡æ¯</view>
    
    <view class="product-action-bar" wx:if="{{mode !== 'view'}}">
      <button class="add-product-btn apple-btn-main compact-btn mini-btn" bindtap="selectProduct">æ·»åŠ è´§å“</button>
    </view>
    
    <!-- è´§å“åˆ—è¡¨ -->
    <view class="product-list">
      <block wx:if="{{selectedProducts && selectedProducts.length > 0}}">
        <view class="product-item" wx:for="{{selectedProducts}}" wx:key="index">
          <view class="product-info">
            <image class="product-image" src="{{item.imageUrl}}" mode="aspectFill"></image>
            <view class="product-details">
              <view class="product-code">è´§å·: {{item.productNo}}</view>
              <view class="product-name">{{item.name}}</view>
              
              <!-- é¢œè‰²å’Œå°ºç åœ¨åŒä¸€è¡Œ - é‡‡ç”¨ç®€æ´çš„æ ‡ç­¾æ ·å¼ -->
              <view class="product-tags">
                <view class="product-tag" wx:if="{{item.color}}">
                  <text class="tag-name">é¢œè‰²:</text>
                  <text class="tag-value">{{item.color}}</text>
                </view>
                <view class="product-tag" wx:if="{{item.size}}">
                  <text class="tag-name">å°ºç :</text>
                  <text class="tag-value">{{item.size}}</text>
                </view>
              </view>
            </view>
          </view>
          
          <view class="product-controls">
            <view class="quantity-weight">
              <view class="control-item">
                <text class="control-label required">æ•°é‡:</text>
                <input wx:if="{{mode !== 'view'}}" class="control-input apple-input" type="digit" value="{{item.quantity}}" bindinput="bindQuantityInput" data-index="{{index}}" />
                <view wx:else class="control-value">{{item.quantity}}</view>
              </view>
              <view class="control-item">
                <text class="control-label">é‡é‡(kg):</text>
                <input wx:if="{{mode !== 'view'}}" class="control-input apple-input" type="digit" value="{{item.weight}}" bindinput="bindWeightInput" data-index="{{index}}" />
                <view wx:else class="control-value">{{item.weight}}</view>
              </view>
              <view class="control-item">
                <text class="control-label">å·¥ä»·:</text>
                <input wx:if="{{mode !== 'view'}}" class="control-input apple-input" type="digit" value="{{item.price}}" bindinput="bindPriceInput" data-index="{{index}}" />
                <view wx:else class="control-value">Â¥{{item.price}}</view>
              </view>
              <view class="control-item">
                <text class="control-label">å°è®¡:</text>
                <view class="control-value">Â¥{{(item.quantity || 0) * (item.price || 0)}}</view>
              </view>
            </view>
            
            <view class="product-actions" wx:if="{{mode !== 'view'}}">
              <button class="btn-same-product" bindtap="addSameProduct" data-index="{{index}}">
                <view class="btn-icon">+</view>
                <view class="btn-text">+</view>
              </button>
              <button class="btn-small btn-danger" bindtap="deleteProduct" data-index="{{index}}">-</button>
            </view>
          </view>
        </view>
      </block>
      
      <view wx:else class="no-products">
        <text>æš‚æ— è´§å“ï¼Œè¯·æ·»åŠ </text>
      </view>
    </view>
    
    <!-- è´§å“æ€»è®¡ -->
    <view class="product-totals">
      <view class="total-item">
        <text>æ€»æ•°é‡: {{totalQuantity || 0}}</text>
      </view>
      <view class="total-item">
        <text>æ€»é‡é‡: {{totalWeight || 0}} kg</text>
      </view>
      <view class="total-item">
        <text>æ€»é‡‘é¢: Â¥ {{totalAmount || 0}}</text>
      </view>
    </view>
  </view>

  <view class="apple-card section">
    <!-- ç§»åŠ¨æ”¯ä»˜æ–¹å¼æ¨¡å—åˆ°åˆ¶å•ä¿¡æ¯ä¸Šæ–¹ -->
    <view class="form-group payment-methods-row">
      <view class="form-label payment-label small-label">æ”¯ä»˜æ–¹å¼ï¼š</view>
      <view class="payment-methods-container single-line">
        <block wx:for="{{paymentMethods}}" wx:key="index">
          <view class="payment-method-item small-method {{paymentMethod === item ? 'active' : ''}}" bindtap="selectPaymentMethodByTap" data-method="{{item}}">
            <view class="payment-method-checkbox">
              <view class="checkbox-inner {{paymentMethod === item ? 'checked' : ''}}"></view>
            </view>
            <text class="payment-method-name">{{item}}</text>
          </view>
        </block>
      </view>
    </view>
    
    <view class="form-group payment-amount-container" wx:if="{{paymentMethod}}">
      <view class="payment-amount-row">
        <view class="payment-input-wrapper">
          <input class="payment-amount-input payment-amount-input-small apple-input" type="digit" placeholder="è¯·è¾“å…¥é‡‘é¢" bindinput="inputPaymentAmount" value="{{paymentAmount}}" />
        </view>
        <view class="order-amount-summary">
          <view class="order-amount-item">
            <text class="order-amount-label">åº”ä»˜ï¼š</text>
            <text class="order-amount-value">Â¥ {{orderPayableAmount}}</text>
          </view>
          <view class="order-amount-item">
            <text class="order-amount-label">ç»“ä½™ï¼š</text>
            <text class="order-amount-value {{remainBalance < 0 ? 'negative' : ''}}">Â¥ {{remainBalance}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <view class="order-meta">
      <view class="order-meta-row">
        <view class="order-meta-item">
          <text class="meta-label">åˆ¶å•å‘˜ï¼š</text>
          <text class="meta-value">{{creator || 'å½“å‰ç”¨æˆ·'}}</text>
        </view>
        <view class="order-meta-item">
          <text class="meta-label">åˆ¶å•æ—¶é—´ï¼š</text>
          <text class="meta-value">{{createTime || '2023-04-28 14:30'}}</text>
        </view>
      </view>
    </view>
    
    <view class="form-group">
      <view class="form-label">å¤‡æ³¨</view>
      <textarea class="form-textarea apple-input" placeholder="è¾“å…¥å¤‡æ³¨ä¿¡æ¯" bindinput="inputRemark" value="{{remark}}" />
    </view>

    <!-- å°†ç…§ç‰‡å¤‡æ³¨ç§»åˆ°å¤‡æ³¨è¾“å…¥æ¡†ä¸‹æ–¹ -->
    <view class="form-group remark-images-group">
      <view class="form-label">å›¾ç‰‡å¤‡æ³¨ (æœ€å¤š3å¼ )</view>
      <view class="remark-images">
        <block wx:for="{{remarkImages}}" wx:key="index">
          <view class="remark-image-item">
            <image class="remark-image" src="{{item}}" mode="aspectFill" bindtap="previewRemarkImage" data-index="{{index}}" />
            <view class="remark-image-delete" bindtap="deleteRemarkImage" data-index="{{index}}">Ã—</view>
          </view>
        </block>
        <!-- æ›´æ–°æ•°é‡é™åˆ¶ä¸º3 -->
        <view class="remark-image-add" bindtap="addRemarkImage" wx:if="{{remarkImages.length < 3}}">
          <text>+</text>
        </view>
      </view>
    </view>
  </view>
      
  <view class="footer-actions apple-footer">
    <button class="btn-primary apple-btn-main save-btn simple-btn" bindtap="submitOrder" wx:if="{{mode !== 'view'}}">
      ä¿å­˜
    </button>
    <view class="back-btn simple-btn" bindtap="navigateBack">
      è¿”å›
    </view>
  </view>
</view>

<view class="product-modal {{showProductModal ? 'show' : ''}}" wx:if="{{showProductModal}}">
  <view class="modal-mask" bindtap="hideProductModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©è´§å“</text>
      <text class="modal-close" bindtap="hideProductModal">Ã—</text>
    </view>
    <view class="modal-search">
      <view class="search-input-container">
        <view class="search-icon">ğŸ”</view>
        <input class="search-input" placeholder="æœç´¢è´§å“" value="{{productSearchKeyword}}" bindinput="searchProducts" />
      </view>
    </view>
    <scroll-view class="modal-body" scroll-y="true">
      <view wx:if="{{filteredProducts.length === 0}}" class="empty-search">
        <view class="empty-text">æœªæ‰¾åˆ°ç›¸å…³è´§å“</view>
      </view>
      <view wx:else class="product-select-list">
        <view class="card list-item-override" wx:for="{{filteredProducts}}" wx:key="id" bindtap="selectProductItem" data-index="{{index}}">
          <view class="list-item-content">
            <image class="list-item-image" src="{{item.imageUrl || '/images/default-product.png'}}" mode="aspectFill"></image>
            <view class="list-item-details">
              <view class="list-item-code">{{item.productNo}}</view>
              <view class="list-item-name">{{item.name}}</view>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>
</view>

<view class="product-confirm-modal {{selectedProductTemp ? 'show' : ''}}" wx:if="{{selectedProductTemp}}">
  <view class="modal-mask" bindtap="hideProductConfirmModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">æ·»åŠ è´§å“</text>
      <text class="modal-close" bindtap="hideProductConfirmModal">Ã—</text>
    </view>
    
    <view class="modal-body">
      <!-- Selected Product Display (same as send-order) -->
      <view class="selected-product">
        <image class="product-image" src="{{selectedProductTemp.imageUrl}}" mode="aspectFill"></image>
        <view class="product-details">
          <view class="product-code">è´§å·: {{selectedProductTemp.productNo}}</view>
          <view class="product-name">{{selectedProductTemp.name}}</view>
        </view>
      </view>
      
      <!-- Edit Form (layout from send-order, adds price field) -->
      <view class="product-edit-form">
        <!-- Row 1: Color and Size -->
        <view class="form-row">
          <!-- Color Picker -->
          <view class="form-col" wx:if="{{selectedProductTemp.colorOptions && selectedProductTemp.colorOptions.length > 0}}">
            <text class="edit-form-label {{tempWeight && parseFloat(tempWeight) > 0 ? '' : 'required'}}">é¢œè‰²</text>
            <picker bindchange="bindColorChange" value="{{selectedProductTemp.colorOptions.indexOf(selectedColorTemp)}}" range="{{selectedProductTemp.colorOptions}}">
              <view class="edit-form-value {{selectedColorTemp ? '' : 'placeholder'}}">
                {{selectedColorTemp || 'è¯·é€‰æ‹©é¢œè‰²'}}
              </view>
            </picker>
          </view>
          
          <!-- Size Picker -->
          <view class="form-col" wx:if="{{selectedProductTemp.sizeOptions && selectedProductTemp.sizeOptions.length > 0}}">
            <text class="edit-form-label {{tempWeight && parseFloat(tempWeight) > 0 ? '' : 'required'}}">å°ºç </text>
            <picker bindchange="bindSizeChange" value="{{selectedProductTemp.sizeOptions.indexOf(selectedSizeTemp)}}" range="{{selectedProductTemp.sizeOptions}}">
              <view class="edit-form-value {{selectedSizeTemp ? '' : 'placeholder'}}">
                {{selectedSizeTemp || 'è¯·é€‰æ‹©å°ºç '}}
              </view>
            </picker>
          </view>
        </view>

        <!-- Row 2: Quantity and Weight -->
        <view class="form-row">
          <!-- Quantity Input -->
          <view class="form-col">
            <text class="edit-form-label required">æ•°é‡</text>
            <input class="quantity-input" type="digit" placeholder="è¯·è¾“å…¥æ•°é‡" bindinput="bindTempQuantityInput" value="{{tempQuantity}}" focus/>
          </view>

          <!-- Weight Input -->
          <view class="form-col">
            <text class="edit-form-label">é‡é‡(kg)</text>
            <input class="weight-input" type="digit" placeholder="è¯·è¾“å…¥é‡é‡" bindinput="bindTempWeightInput" value="{{tempWeight}}"/>
          </view>
        </view>
        
        <!-- Price Input (Directly under product-edit-form) -->
        <view class="form-group price-group"> <!-- Use form-group for spacing -->
          <text class="edit-form-label required">å·¥ä»·</text>
          <input class="price-input full-width-input" type="digit" placeholder="è¯·è¾“å…¥å·¥ä»·" bindinput="bindTempPriceInput" value="{{tempPrice}}"/>
        </view>
      </view>
      
      <!-- Actions (layout from send-order) -->
      <view class="modal-actions">
        <button class="btn-primary full-width-btn" hover-class="btn-hover" bindtap="addSelectedProduct">ç¡®è®¤æ·»åŠ </button>
        <view class="btn-add-continue" hover-class="btn-hover" bindtap="addSelectedProductAndContinue">+</view>
        <button class="btn-default full-width-btn" hover-class="btn-hover" bindtap="hideProductConfirmModal">å–æ¶ˆ</button>
      </view>
    </view>
  </view>
</view>

<!-- å¯¼å‡ºå›¾ç‰‡æ—¶çš„éšè—canvas -->
<canvas type="2d" id="shareCanvas" style="width: {{canvasWidth}}px; height: {{canvasHeight}}px; position: fixed; top: -9999px;" id="shareCanvas"></canvas>

<!-- å›¾ç‰‡åˆ†äº«å¼¹çª— -->
<view class="modal-mask" wx:if="{{showShareModalFlag}}" bindtap="hideShareModal" catchtouchmove="preventTouchMove"></view>
<view class="modal-dialog share-dialog" wx:if="{{showShareModalFlag}}">
  <view class="modal-header">
    <text>æ”¶å›å•åˆ†äº«</text>
    <view class="close-btn" bindtap="hideShareModal">Ã—</view>
  </view>
  
  <view class="modal-content">
    <view class="share-preview">
      <image class="share-image" src="{{shareImagePath}}" mode="widthFix"></image>
    </view>
    <view class="share-tips">å•æ®å·²å®Œæˆï¼Œè¯·é€‰æ‹©ä¿å­˜å›¾ç‰‡æˆ–åˆ†äº«ç»™å¥½å‹</view>
  </view>
  
  <view class="modal-footer">
    <button class="btn cancel-btn" bindtap="hideShareModal">è¿”å›</button>
    <button class="btn save-btn" bindtap="saveImageToAlbum">ä¿å­˜å›¾ç‰‡</button>
    <button class="btn confirm-btn" open-type="share">åˆ†äº«ç»™å¥½å‹</button>
  </view>
</view>