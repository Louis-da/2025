<wxs src="../../utils/utils.wxs" module="utils" />

<view class="page-bg">
  <!-- 基础信息卡片（仅在查看模式显示，精简版，横向排列） -->
  <view class="info-simple-header" wx:if="{{mode === 'view'}}">
    <view class="info-row-horizontal">
      <view class="info-item-col">
        <view class="info-label">工厂</view>
        <view class="info-value">{{selectedFactory.name || '-'}}</view>
      </view>
      <view class="info-item-col">
        <view class="info-label">工序</view>
        <view class="info-value">{{selectedProcess.name || selectedProcess || '-'}}</view>
      </view>
    </view>
  </view>
  
  <!-- 工厂和工序信息卡片 -->
  <view class="card section info-section" wx:if="{{mode !== 'view'}}">
    <view class="form-row factory-process-row">
      <view class="form-col factory-col">
        <view class="form-label required">工厂</view>
        <view class="factory-dropdown-container">
          <view class="factory-search-input-wrapper">
            <input 
              class="form-value apple-input {{selectedFactory ? '' : 'placeholder'}}" 
              placeholder="输入工厂名称或首字母"
              value="{{factorySearchKeyword}}"
              bindinput="onFactorySearch"
              bindtap="showFactoryDropdown"
              bindfocus="showFactoryDropdown"
              bindblur="hideFactoryDropdownWithDelay"
              confirm-type="search"
            />
          </view>
          <!-- 苹果简约风下拉列表 -->
          <view class="factory-dropdown {{showFactoryDropdown ? 'show' : ''}}" wx:if="{{showFactoryDropdown}}">
            <scroll-view class="dropdown-scroll" scroll-y="true">
              <view wx:if="{{filteredFactories.length === 0}}" class="dropdown-empty">
                <view class="empty-icon">🏭</view>
                <view class="empty-text">未找到相关工厂</view>
              </view>
              <view wx:else class="factory-dropdown-list">
                <view 
                  class="factory-dropdown-item {{selectedFactory && selectedFactory.id === item.id ? 'selected' : ''}}" 
                  wx:for="{{filteredFactories}}" 
                  wx:key="id" 
                  catchtap="selectFactoryFromDropdown" 
                  data-factory="{{item}}"
                >
                  <view class="factory-info">
                    <view class="factory-name">{{item.name}}</view>
                    <view class="factory-details" wx:if="{{item.phone || item.address}}">
                      <text class="factory-phone" wx:if="{{item.phone}}">📞 {{item.phone}}</text>
                      <text class="factory-address" wx:if="{{item.address}}">📍 {{item.address}}</text>
                    </view>
                  </view>
                  <view class="check-mark" wx:if="{{selectedFactory && selectedFactory.id === item.id}}">✓</view>
                </view>
              </view>
            </scroll-view>
          </view>
        </view>
        <view class="selected-factory-display" wx:if="{{selectedFactory}}">
          已选择：{{selectedFactory.name}}
        </view>
        <view class="factory-account-status" wx:if="{{selectedFactory}}">
          <text class="account-status-label">账户状态：</text>
          <block wx:if="{{selectedFactory.balance > 0}}">
            <text class="account-status-value balance-positive">余款 ￥{{selectedFactory.balance}}</text>
          </block>
          <block wx:elif="{{selectedFactory.debt > 0}}">
            <text class="account-status-value balance-negative">欠款 ￥{{selectedFactory.debt}}</text>
          </block>
          <block wx:else>
            <text class="account-status-value balance-zero">￥0</text>
          </block>
        </view>
      </view>
      <view class="form-col process-col">
        <view class="form-label required">工序</view>
        <picker bindchange="selectProcess" range="{{processes}}" range-key="name">
          <view class="form-value apple-input {{selectedProcess ? '' : 'placeholder'}}">
            {{selectedProcess.name || selectedProcess || '请选择'}}
          </view>
        </picker>
      </view>
    </view>
  </view>

  <!-- 货品信息卡片 -->
  <view class="card section">
    <view class="section-title">货品信息</view>
    <view class="product-action-bar" wx:if="{{mode !== 'view'}}">
      <button class="add-product-btn apple-btn" bindtap="selectProduct">添加货品</button>
    </view>
    <view class="product-list">
      <block wx:if="{{selectedProducts && selectedProducts.length > 0}}">
        <view class="product-item" wx:for="{{selectedProducts}}" wx:key="index">
          <view class="product-info">
            <image class="product-image" src="{{utils.getFullImageUrl(item.image)}}" mode="aspectFill"></image>
            <view class="product-details">
              <view class="product-code">货号: {{item.productNo}}</view>
              <view class="product-name">{{item.name}}</view>
              <view class="product-tags">
                <view class="product-tag" wx:if="{{item.color}}">
                  <text class="tag-name">颜色:</text>
                  <text class="tag-value">{{item.color}}</text>
                </view>
                <view class="product-tag" wx:if="{{item.size}}">
                  <text class="tag-name">尺码:</text>
                  <text class="tag-value">{{item.size}}</text>
                </view>
                <view class="product-actions-inline" wx:if="{{mode !== 'view'}}">
                  <button class="btn-same-product apple-btn" bindtap="addSameProduct" data-index="{{index}}">+</button>
                  <button class="btn-small btn-danger apple-btn" bindtap="deleteProduct" data-index="{{index}}">-</button>
                </view>
              </view>
            </view>
          </view>
          <view class="product-controls">
            <view class="quantity-weight">
              <view class="control-item">
                <text class="control-label required">数量:</text>
                <input wx:if="{{mode !== 'view'}}" class="control-input apple-input" type="digit" value="{{item.quantity}}" bindinput="bindQuantityInput" data-index="{{index}}" />
                <view wx:else class="control-value-container">
                  <text class="control-value">{{item.quantity}}</text>
                  <text class="control-unit">打</text>
                </view>
              </view>
              <view class="control-item">
                <text class="control-label">重量:</text>
                <input wx:if="{{mode !== 'view'}}" class="control-input apple-input" type="digit" value="{{item.weight}}" bindinput="bindWeightInput" data-index="{{index}}" />
                <view wx:else class="control-value-container">
                  <text class="control-value">{{item.weight}}</text>
                  <text class="control-unit">kg</text>
                </view>
              </view>
            </view>
            <view class="quantity-weight" style="margin-top: 0;">
              <view class="control-item">
                <text class="control-label">工价:</text>
                <input wx:if="{{mode !== 'view'}}" class="control-input apple-input" type="digit" value="{{item.fee}}" bindinput="bindPriceInput" data-index="{{index}}" />
                <view wx:else class="control-value">¥{{item.fee}}</view>
              </view>
              <view class="control-item">
                <text class="control-label">小计:</text>
                <view class="control-value">¥{{(item.quantity || 0) * (item.fee || 0)}}</view>
              </view>
            </view>
          </view>
        </view>
      </block>
      <view wx:else class="no-products">
        <text>暂无货品，请添加</text>
      </view>
    </view>
    <view class="product-totals">
      <view class="total-item">
        <text class="total-label">总数量: </text>
        <text class="total-value">{{totalQuantity || 0}}</text>
        <text class="total-unit">打</text>
      </view>
      <view class="total-item">
        <text class="total-label">总重量: </text>
        <text class="total-value">{{totalWeight || 0}}</text>
        <text class="total-unit">kg</text>
      </view>
      <view class="total-item">
        <text class="total-label">总金额: ¥ </text>
        <text class="total-value">{{totalAmount || 0}}</text>
      </view>
    </view>
  </view>

  <!-- 支付方式及备注卡片 -->
  <view class="card section">
    <view class="section-title">支付与备注</view>
    <view class="form-group payment-methods-row">
      <view class="form-label payment-label small-label">支付方式：</view>
      <view class="payment-methods-container single-line">
        <block wx:for="{{paymentMethods}}" wx:key="index">
          <view class="payment-method-item small-method {{paymentMethod === item ? 'active' : ''}}" bindtap="selectPaymentMethodByTap" data-method="{{item}}">
            <view class="payment-method-checkbox">
              <view class="checkbox-inner {{paymentMethod === item ? 'checked' : ''}}"></view>
            </view>
            <text class="payment-method-name">{{item}}</text>
          </view>
        </block>
      </view>
    </view>
    <view class="form-group payment-amount-container" wx:if="{{paymentMethod}}">
      <view class="payment-amount-row">
        <view class="payment-input-wrapper">
          <input class="payment-amount-input apple-input" type="digit" placeholder="请输入金额" bindinput="inputPaymentAmount" value="{{paymentAmount}}" />
        </view>
        <view class="order-amount-summary">
          <view class="order-amount-item">
            <text class="order-amount-label">应付：</text>
            <text class="order-amount-value">¥ {{orderPayableAmount}}</text>
          </view>
          <view class="order-amount-item">
            <text class="order-amount-label">结余：</text>
            <text class="order-amount-value {{remainBalance < 0 ? 'negative' : ''}}">¥ {{remainBalance}}</text>
          </view>
        </view>
      </view>
    </view>
    <view class="order-meta" style="display: flex; flex-direction: row; justify-content: space-between; align-items: center;">
      <text class="meta-label">制单人：</text>
      <text class="meta-value">{{staff || '当前用户'}}</text>
      <text class="meta-label" style="margin-left:auto;">制单时间：</text>
      <text class="meta-value">{{date}}</text>
    </view>
    <view class="form-group">
      <view class="form-label">备注</view>
      <textarea class="form-textarea apple-input" placeholder="输入备注信息" bindinput="inputRemark" value="{{remark}}" />
    </view>
    <view class="form-group remark-images-group">
      <view class="form-label">图片备注 (最多3张)</view>
      <view class="remark-images">
        <block wx:for="{{remarkImages}}" wx:key="index">
          <view class="remark-image-item">
            <image class="remark-image" src="{{item}}" mode="aspectFill" bindtap="previewRemarkImage" data-index="{{index}}" />
            <view class="remark-image-delete" bindtap="deleteRemarkImage" data-index="{{index}}">×</view>
          </view>
        </block>
        <view class="remark-image-add" bindtap="addRemarkImage" wx:if="{{remarkImages.length < 3}}">
          <text>+</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 底部操作栏 -->
  <view class="footer-actions" style="display: flex; flex-direction: row; justify-content: space-between; align-items: center; padding: 0 16px 16px 16px;">
    <button class="btn-danger apple-btn" style="flex: 1; max-width: 90px; margin-right: 12px;" bindtap="cancelOrder" wx:if="{{mode === 'view' && orderStatus !== 0 && orderStatus !== 'canceled'}}">作废</button>
    <button class="btn-default apple-btn" style="flex: 2; margin-right: 12px;" bindtap="navigateBack">返回</button>
    <button class="btn-primary apple-btn" style="flex: 3;" bindtap="submitOrder" wx:if="{{mode !== 'view'}}">保存</button>
  </view>

  <!-- 货品选择弹窗 -->
  <view class="product-modal {{showProductModal ? 'show' : ''}}" wx:if="{{showProductModal}}">
    <view class="modal-mask" bindtap="hideProductModal"></view>
    <view class="modal-content card">
      <view class="modal-header">
        <text class="modal-title">选择货品</text>
        <text class="modal-close" bindtap="hideProductModal">×</text>
      </view>
      <view class="modal-search">
        <input class="apple-input" placeholder="搜索货品" value="{{productSearchKeyword}}" bindinput="searchProducts" />
      </view>
      <scroll-view class="modal-body" scroll-y="true">
        <view wx:if="{{filteredProducts.length === 0}}" class="empty-search">
          <view class="empty-text">未找到相关货品</view>
        </view>
        <view wx:else class="product-select-list">
          <view class="card list-item-override" wx:for="{{filteredProducts}}" wx:key="id" bindtap="selectProductItem" data-index="{{index}}">
            <view class="list-item-content">
              <image class="list-item-image" src="{{utils.getFullImageUrl(item.image)}}" mode="aspectFill"></image>
              <view class="list-item-details">
                <view class="list-item-code">{{item.productNo}}</view>
                <view class="list-item-name">{{item.name}}</view>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- 货品选择弹窗 -->
  <view class="product-confirm-modal {{selectedProductTemp ? 'show' : ''}}" wx:if="{{selectedProductTemp}}">
    <view class="modal-mask" bindtap="hideProductConfirmModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">添加货品</text>
        <text class="modal-close" bindtap="hideProductConfirmModal">×</text>
      </view>
      
      <view class="modal-body">
        <!-- Selected Product Display (same as send-order) -->
        <view class="selected-product">
          <image class="product-image" src="{{utils.getFullImageUrl(selectedProductTemp.image)}}" mode="aspectFill"></image>
          <view class="product-details">
            <view class="product-code">货号: {{selectedProductTemp.productNo}}</view>
            <view class="product-name">{{selectedProductTemp.name}}</view>
          </view>
        </view>
        
        <!-- Edit Form (layout from send-order, adds price field) -->
        <view class="product-edit-form">
          <!-- 颜色和尺码选择（同步货品信息） -->
          <view class="form-row">
            <view class="form-col">
              <text class="edit-form-label">颜色</text>
              <picker bindchange="bindTempColorPicker" value="{{selectedProductTemp.colorOptions.indexOf(tempColor)}}" range="{{selectedProductTemp.colorOptions}}">
                <view class="edit-form-value {{tempColor ? '' : 'placeholder'}}">
                  {{tempColor || '请选择颜色'}}
                  <view class="picker-arrow"></view>
                </view>
              </picker>
            </view>
            <view class="form-col">
              <text class="edit-form-label">尺码</text>
              <picker bindchange="bindTempSizePicker" value="{{selectedProductTemp.sizeOptions.indexOf(tempSize)}}" range="{{selectedProductTemp.sizeOptions}}">
                <view class="edit-form-value {{tempSize ? '' : 'placeholder'}}">
                  {{tempSize || '请选择尺码'}}
                  <view class="picker-arrow"></view>
                </view>
              </picker>
            </view>
          </view>
          <!-- Row 2: Quantity and Weight -->
          <view class="form-row">
            <!-- Quantity Input -->
            <view class="form-col">
              <text class="edit-form-label required">数量(打)</text>
              <input class="quantity-input" type="digit" placeholder="请输入数量" bindinput="bindTempQuantityInput" value="{{tempQuantity}}" focus/>
            </view>

            <!-- Weight Input -->
            <view class="form-col">
              <text class="edit-form-label">重量(kg)</text>
              <input class="weight-input" type="digit" placeholder="请输入重量" bindinput="bindTempWeightInput" value="{{tempWeight}}"/>
            </view>
          </view>
          
          <!-- Price Input (Directly under product-edit-form) -->
          <view class="form-group price-group"> <!-- Use form-group for spacing -->
            <text class="edit-form-label required">工价</text>
            <input class="price-input full-width-input" type="digit" placeholder="请输入工价" bindinput="bindTempPriceInput" value="{{tempPrice}}"/>
          </view>
        </view>
        
        <!-- Actions (layout from send-order) -->
        <view class="modal-actions">
          <view class="btn-add-continue" hover-class="btn-hover" bindtap="addSelectedProductAndContinue">+</view>
          <button class="btn-primary full-width-btn" hover-class="btn-hover" bindtap="addSelectedProduct">确认添加</button>
          <button class="btn-default full-width-btn" hover-class="btn-hover" bindtap="hideProductConfirmModal">取消</button>
        </view>
      </view>
    </view>
  </view>

  <!-- 导出图片时的隐藏canvas -->
  <canvas type="2d" id="shareCanvas" style="width: {{canvasWidth}}px; height: {{canvasHeight}}px; position: fixed; top: -9999px;" id="shareCanvas"></canvas>

  <!-- 图片分享弹窗 -->
  <view class="modal-mask" wx:if="{{showShareModalFlag}}" bindtap="hideShareModal" catchtouchmove="preventTouchMove"></view>
  <view class="modal-dialog share-dialog" wx:if="{{showShareModalFlag}}">
    <view class="modal-header">
      <text>收回单分享</text>
      <view class="close-btn" bindtap="hideShareModal">×</view>
    </view>
    
    <view class="modal-content">
      <view class="share-preview">
        <image class="share-image" src="{{shareImagePath}}" mode="widthFix"></image>
      </view>
      <view class="share-tips">单据已完成，请选择保存图片或分享给好友</view>
    </view>
    
    <view class="modal-footer">
      <button class="btn cancel-btn" bindtap="hideShareModal">返回</button>
      <button class="btn save-btn" bindtap="saveImageToAlbum">保存图片</button>
      <button class="btn confirm-btn" open-type="share">分享给好友</button>
    </view>
  </view>

  <!-- 页面底部新增作废订单按钮 -->
  <!-- （已合并到footer-actions，不再单独显示） -->
</view>