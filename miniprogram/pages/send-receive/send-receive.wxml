<view class="page-bg">
  <!-- 导航选项卡 -->
  <view class="card tabs-card">
    <view class="tabs">
      <view class="tab {{activeTab === 'send' ? 'active' : ''}}" bindtap="switchTab" data-tab="send">发出单</view>
      <view class="tab {{activeTab === 'receive' ? 'active' : ''}}" bindtap="switchTab" data-tab="receive">收回单</view>
    </view>
  </view>

  <!-- 报表入口 -->
  <view class="card report-card">
    <view class="report-entry">
      <view class="report-item" bindtap="navigateToFlowTable">
        <image class="report-icon" src="/images/ui/flow-table.svg" mode="aspectFit"></image>
        <view class="report-text">收发流水表</view>
      </view>
      <view class="report-item" bindtap="navigateToStatement">
        <image class="report-icon" src="/images/ui/statement.svg" mode="aspectFit"></image>
        <view class="report-text">对账单</view>
      </view>
    </view>
  </view>

  <!-- 搜索栏 -->
  <view class="card search-card">
    <view class="search-container">
      <view class="search-box">
        <view class="search-icon">🔍</view>
        <input class="search-input" placeholder="搜索单号、工厂" bindinput="inputSearch" value="{{searchQuery}}" confirm-type="search" />
        <view class="search-clear" bindtap="clearSearch" wx:if="{{searchQuery}}">✕</view>
      </view>
      <view class="filter-btn" bindtap="openFilter">
        <image class="filter-icon" src="/images/ui/filter.svg" mode="aspectFit"></image>
      </view>
    </view>
  </view>
  
  <!-- 订单列表 -->
  <view class="card order-list-card">
    <scroll-view class="order-list" scroll-y enable-flex>
      <view wx:if="{{orders.length === 0}}" class="empty-list">
        <image class="empty-icon" src="/images/ui/empty.svg" mode="aspectFit"></image>
        <view class="empty-text">暂无数据</view>
      </view>
      <view wx:else class="list">
        <view wx:for="{{orders}}" wx:key="id" class="order-item-wrapper">
          <view class="order-item {{item.status === 0 ? 'canceled' : ''}}" bindtap="viewOrderDetail" data-id="{{item.id}}">
            <view class="order-header">
              <view class="order-no-small-gray">{{item.orderNo || '无单号'}}</view>
              <view class="order-status" wx:if="{{item.status === 0}}">已作废</view>
              <view class="share-icon share-icon-purple" catchtap="handleShare" data-id="{{item.id}}" data-type="{{activeTab}}" wx:if="{{item.status !== 0}}">
                <image src="/images/ui/share.svg" mode="aspectFit"></image>
              </view>
            </view>
            <view class="order-factory">{{item.factoryName || '未知工厂'}} <text wx:if="{{item.process}}">- {{item.process}}</text></view>
            <view class="order-details">
              <view class="detail-item">
                <view class="detail-label">重量</view>
                <view class="detail-value">{{item.totalWeight || item.weight || 0}}kg</view>
              </view>
              <view class="detail-item">
                <view class="detail-label">数量</view>
                <view class="detail-value">{{item.totalQuantity || item.quantity || 0}}打</view>
              </view>
              <view class="detail-item" wx:if="{{item.fee && activeTab === 'receive'}}">
                <view class="detail-label">工费</view>
                <view class="detail-value">¥{{item.fee}}</view>
              </view>
            </view>
            <view class="order-footer">
              <view class="order-staff">制单：{{item.staff || '未知'}}</view>
              <view class="order-date">{{item.date || '无日期'}}</view>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 新增按钮 -->
  <view class="add-button" bindtap="navigateToAdd">
    <view class="add-icon">+</view>
  </view>
  
  <!-- 底部统计信息 -->
  <view class="bottom-statistics">
    <view wx:if="{{activeTab === 'send'}}" class="statistics-content send-statistics">
      <view class="stat-item">
        <text class="stat-label">共</text>
        <text class="stat-value">{{totalSendCount}}</text>
        <text class="stat-unit">单</text>
      </view>
      <view class="stat-separator">|</view>
      <view class="stat-item">
        <text class="stat-label">数量</text>
        <text class="stat-value {{totalSendQuantityClass}}">{{totalSendQuantity}}</text>
        <text class="stat-unit">打</text>
      </view>
      <view class="stat-separator">|</view>
      <view class="stat-item">
        <text class="stat-label">重量</text>
        <text class="stat-value {{totalSendWeightClass}}">{{totalSendWeight}}</text>
        <text class="stat-unit">kg</text>
      </view>
    </view>
    
    <view wx:if="{{activeTab === 'receive'}}" class="statistics-content receive-statistics">
      <view class="stat-item">
        <text class="stat-label">共</text>
        <text class="stat-value">{{totalReceiveCount}}</text>
        <text class="stat-unit">单</text>
      </view>
      <view class="stat-separator">|</view>
      <view class="stat-item">
        <text class="stat-label">数量</text>
        <text class="stat-value {{totalReceiveQuantityClass}}">{{totalReceiveQuantity}}</text>
        <text class="stat-unit">打</text>
      </view>
      <view class="stat-separator">|</view>
      <view class="stat-item">
        <text class="stat-label">重量</text>
        <text class="stat-value {{totalReceiveWeightClass}}">{{totalReceiveWeight}}</text>
        <text class="stat-unit">kg</text>
      </view>
      <view class="stat-separator">|</view>
      <view class="stat-item">
        <text class="stat-label">金额</text>
        <text class="stat-value {{totalAmountClass}}">¥{{totalAmount}}</text>
      </view>
      <view class="stat-separator">|</view>
      <view class="stat-item">
        <text class="stat-label">支付</text>
        <text class="stat-value {{totalPaymentClass}}">¥{{totalPayment}}</text>
      </view>
    </view>
  </view>
</view>

<!-- 筛选弹窗 -->
<view class="filter-modal {{showFilter ? 'filter-show' : ''}}">
  <view class="filter-overlay" bindtap="closeFilter"></view>
  <view class="filter-content">
    <view class="filter-header">
      <view class="filter-title">筛选条件</view>
      <view class="filter-close" bindtap="closeFilter">✕</view>
    </view>
    <view class="filter-body">
      <!-- 日期范围 -->
      <view class="filter-section">
        <view class="filter-label">日期范围</view>
        <view class="date-range">
          <picker mode="date" value="{{filterStartDate}}" bindchange="onStartDateChange">
            <view class="date-picker">{{filterStartDate || '开始日期'}}</view>
          </picker>
          <view class="date-separator">至</view>
          <picker mode="date" value="{{filterEndDate}}" bindchange="onEndDateChange">
            <view class="date-picker">{{filterEndDate || '结束日期'}}</view>
          </picker>
        </view>
      </view>
      
      <!-- 工厂选择 -->
      <view class="filter-section">
        <view class="filter-label">工厂</view>
        <view class="factory-dropdown-container">
          <view class="factory-search-input-wrapper">
            <input 
              class="filter-input {{selectedFilterFactory ? 'has-value' : ''}}" 
              placeholder="输入工厂名称或首字母"
              value="{{filterFactorySearchKeyword}}"
              bindinput="onFilterFactorySearch"
              bindtap="showFilterFactoryDropdown"
              bindfocus="showFilterFactoryDropdown"
              bindblur="hideFilterFactoryDropdownWithDelay"
              confirm-type="search"
            />
          </view>
          <!-- 苹果简约风下拉列表 -->
          <view class="factory-dropdown {{showFilterFactoryDropdown ? 'show' : ''}}" wx:if="{{showFilterFactoryDropdown}}">
            <scroll-view class="dropdown-scroll" scroll-y="true">
              <view wx:if="{{filteredFilterFactories.length === 0}}" class="dropdown-empty">
                <view class="empty-icon">🏭</view>
                <view class="empty-text">未找到相关工厂</view>
              </view>
              <view wx:else class="factory-dropdown-list">
                <!-- 全部工厂选项 -->
                <view 
                  class="factory-dropdown-item {{!selectedFilterFactory ? 'selected' : ''}}" 
                  catchtap="selectFilterFactoryFromDropdown" 
                  data-factory=""
                >
                  <view class="factory-info">
                    <view class="factory-name">全部工厂</view>
                    <view class="factory-details">
                      <text class="factory-subtitle">查看所有工厂的订单</text>
                    </view>
                  </view>
                  <view class="check-mark" wx:if="{{!selectedFilterFactory}}">✓</view>
                </view>
                <!-- 具体工厂选项 -->
                <view 
                  class="factory-dropdown-item {{selectedFilterFactory && selectedFilterFactory.id === item.id ? 'selected' : ''}}" 
                  wx:for="{{filteredFilterFactories}}" 
                  wx:key="id" 
                  catchtap="selectFilterFactoryFromDropdown" 
                  data-factory="{{item}}"
                >
                  <view class="factory-info">
                    <view class="factory-name">{{item.name}}</view>
                    <view class="factory-details" wx:if="{{item.phone || item.address}}">
                      <text class="factory-phone" wx:if="{{item.phone}}">📞 {{item.phone}}</text>
                      <text class="factory-address" wx:if="{{item.address}}">📍 {{item.address}}</text>
                    </view>
                  </view>
                  <view class="check-mark" wx:if="{{selectedFilterFactory && selectedFilterFactory.id === item.id}}">✓</view>
                </view>
              </view>
            </scroll-view>
          </view>
        </view>
      </view>
      
      <!-- 工序选择 -->
      <view class="filter-section">
        <view class="filter-label">工序</view>
        <picker bindchange="onProcessChange" value="{{filterProcessIndex}}" range="{{processOptions}}" range-key="name">
          <view class="filter-picker {{filterProcessIndex > 0 ? 'has-value' : ''}}">
            {{filterProcessIndex > 0 ? processOptions[filterProcessIndex].name : '选择工序'}}
          </view>
        </picker>
      </view>
      
      <!-- 货号输入 -->
      <view class="filter-section">
        <view class="filter-label">货号</view>
        <input class="filter-input" placeholder="输入货号" bindinput="onProductCodeInput" value="{{filterProductCode}}" />
      </view>
      
      <!-- 状态选择 -->
      <view class="filter-section">
        <view class="filter-label">状态</view>
        <picker bindchange="onStatusChange" value="{{filterStatusIndex}}" range="{{statusOptions}}">
          <view class="filter-picker">
            {{statusOptions[filterStatusIndex]}}
          </view>
        </picker>
      </view>
    </view>
    
    <view class="filter-footer">
      <button class="filter-reset" bindtap="resetFilter">重置</button>
      <button class="filter-apply" bindtap="applyFilter">确定</button>
    </view>
  </view>
</view>

<!-- 新增canvas用于绘制分享图片 -->
<canvas type="2d" id="shareCanvas" style="width: 1100px; height: 1900px; position: fixed; left: -9999px; top: -9999px;"></canvas>