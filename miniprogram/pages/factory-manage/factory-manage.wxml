<view class="container">
  <!-- 搜索栏 -->
  <view class="search-bar">
    <view class="search-input-box">
      <icon type="search" size="18" color="#999" />
      <input placeholder="搜索工厂名称或联系人" bindinput="searchFactories" value="{{keyword}}" confirm-type="search" />
      <icon wx:if="{{keyword}}" type="clear" size="18" color="#999" bindtap="clearSearch" />
    </view>
  </view>

  <!-- 工厂列表 -->
  <view class="factory-list">
    <view wx:if="{{factories.length === 0 && !isLoading}}" class="empty-tips">
      <image src="/images/icon-empty.png" mode="aspectFit"></image>
      <text>暂无工厂信息</text>
    </view>
    
    <view wx:for="{{factories}}" wx:key="_id" class="factory-item {{item.status === 'inactive' ? 'inactive' : ''}}">
      <view class="factory-header">
        <view class="factory-name">{{item.name}}</view>
        <view class="factory-status" wx:if="{{item.status !== 1}}">已停用</view>
      </view>
      
      <view class="factory-info">
        <view class="info-item">
          <text class="label">联系电话：</text>
          <text class="value">{{item.phone || '未设置'}}</text>
        </view>
        <view class="info-item">
          <text class="label">主营工序：</text>
          <block wx:if="{{item.processes}}">
            <text wx:if="{{item.processes.length > 0}}" class="processes">{{item.processes.join('、')}}</text>
            <text wx:else class="processes-empty">未设置</text>
          </block>
          <text wx:else class="processes-empty">未设置</text>
        </view>
        <view class="info-item">
          <text class="label">地址：</text>
          <text class="value">{{item.address || '未设置'}}</text>
        </view>
        <view wx:if="{{item.remark}}" class="info-item">
          <text class="label">备注：</text>
          <text class="value remark">{{item.remark}}</text>
        </view>
        
        <view class="factory-extra">
          <view class="balance-info">
            <view class="balance-item">
              <text>账户状态：</text>
              <block wx:if="{{item.balance > 0}}">
                <text class="balance">余款 ￥{{item.balance}}</text>
              </block>
              <block wx:elif="{{item.debt > 0}}">
                <text class="debt">欠款 ￥{{item.debt}}</text>
              </block>
              <block wx:else>
                <text class="balance-zero">￥0</text>
              </block>
            </view>
          </view>
          <view class="factory-actions">
            <view class="action-group">
              <button class="btn-detail" catchtap="viewAccountDetail" data-id="{{item._id}}" data-name="{{item.name}}">
                <text>账户详情</text>
              </button>
              
              <block wx:if="{{item.debt > 0}}">
                <button class="btn-pay" catchtap="openPayDebtModal" data-id="{{item._id}}" data-name="{{item.name}}" data-debt="{{item.debt}}">
                  <text>付款</text>
                </button>
              </block>
              
              <button class="btn-edit" catchtap="editFactory" data-id="{{item._id}}">
                <text>编辑</text>
              </button>
              
              <button class="btn-enable" wx:if="{{item.status === 0}}" catchtap="toggleStatus" data-id="{{item._id}}" data-status="{{item.status}}">
                启用
              </button>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 加载提示 -->
    <view wx:if="{{isLoading}}" class="loading-tips">
      <view class="loading-icon"></view>
      <text>加载中...</text>
    </view>
    
    <!-- 加载更多提示 -->
    <view wx:if="{{!isLoading && hasMore}}" class="load-more" bindtap="loadMoreFactories">
      点击加载更多
    </view>
    
    <!-- 列表底部提示 -->
    <view wx:if="{{!isLoading && !hasMore && factories.length > 0}}" class="list-end-tips">
      已显示全部 {{totalCount}} 条数据
    </view>
  </view>
  
  <!-- 添加按钮 -->
  <view class="add-btn" bindtap="navigateToEdit">
    <text>+</text>
  </view>
  
  <!-- 编辑工厂弹窗 -->
  <view class="modal-container" wx:if="{{showEditModal}}">
    <view class="modal-mask" catchtouchmove="preventTouchMove"></view>
    <view class="modal">
      <view class="modal-header">
        <text class="title">{{isAdding ? '新增工厂' : '修改工厂'}}</text>
        <view class="close-btn" bindtap="closeEditModal">×</view>
      </view>
      <view class="modal-body">
        <view class="form-group">
          <view class="form-label">工厂名称</view>
          <input class="form-input" value="{{editingFactory.name}}" disabled="{{nameReadOnly}}" bindinput="inputChange" data-field="name" placeholder="请输入工厂名称" />
          <view class="helper-text" wx:if="{{nameReadOnly}}">该工厂有余额或欠款，不能修改名称</view>
        </view>
        
        <view class="form-group">
          <view class="form-label">联系电话</view>
          <input class="form-input" type="number" value="{{editingFactory.phone}}" disabled="{{phoneReadOnly}}" bindinput="inputChange" data-field="phone" placeholder="请输入手机号（选填）" />
          <view class="helper-text" wx:if="{{phoneReadOnly}}">该工厂有余额或欠款，不能修改电话</view>
        </view>
        
        <view class="form-group">
          <view class="form-label">主营工序</view>
          <view class="multi-selector">
            <view class="selected-items">
              <block wx:if="{{editingFactory.processes && editingFactory.processes.length > 0}}">
              <view wx:for="{{editingFactory.processes}}" wx:key="index" class="tag tag-blue">
                {{item}}
                <text class="tag-close" catchtap="removeProcess" data-index="{{index}}">×</text>
              </view>
              </block>
              <view wx:else class="no-processes-hint">暂无选择工序</view>
            </view>
            <view class="selector-action" bindtap="showProcessSelector">
              <text class="{{editingFactory.processes && editingFactory.processes.length > 0 ? '' : 'placeholder'}}">{{editingFactory.processes && editingFactory.processes.length > 0 ? '添加工序' : '请选择工序'}}</text>
              <view class="add-icon">+</view>
            </view>
          </view>
        </view>
        
        <view class="form-group">
          <view class="form-label">地址</view>
          <input class="form-input" value="{{editingFactory.address}}" bindinput="inputChange" data-field="address" placeholder="请输入工厂地址" />
        </view>
        
        <view class="form-group">
          <view class="form-label">备注</view>
          <textarea class="form-textarea" value="{{editingFactory.remark}}" bindinput="inputChange" data-field="remark" placeholder="请输入备注信息" maxlength="200" />
        </view>
      </view>
      <view class="modal-footer">
        <view 
          class="disable-btn" 
          wx:if="{{!isAdding && (editingFactory.status == 1 || editingFactory.status == 'active')}}"
          bindtap="disableFactory"
          style="margin-right: 16rpx; color: #f56c6c; border: 1rpx solid #f56c6c; background: #fff;"
        >停用</view>
        <view class="cancel-btn" bindtap="closeEditModal">取消</view>
        <view class="confirm-btn" bindtap="submitFactory">确定</view>
      </view>
    </view>
  </view>

  <!-- 添加支付欠款弹窗 -->
  <view class="modal-mask" wx:if="{{showPayDebtModal}}" bindtap="closePayDebtModal" catchtouchmove="preventTouchMove"></view>
  <view class="modal-dialog pay-debt-modal" wx:if="{{showPayDebtModal}}">
    <view class="modal-header">
      <text>支付欠款</text>
      <view class="close-btn" bindtap="closePayDebtModal">×</view>
    </view>
    
    <view class="modal-content">
      <view class="debt-summary">
        <view class="debt-factory-name">{{payingFactory.name}}</view>
        <view class="debt-amount">当前欠款: ¥{{payingFactory.debt}}</view>
      </view>
      
      <view class="form-group">
        <text class="form-label required">支付金额</text>
        <input 
          class="form-input" 
          type="digit" 
          placeholder="请输入支付金额" 
          value="{{payAmount}}" 
          bindinput="inputPayAmount"
          focus="true"
        />
        <text class="helper-text" wx:if="{{payAmount > payingFactory.debt}}">金额大于欠款，多余部分将计入余额</text>
      </view>
      
      <view class="form-group">
        <text class="form-label required">支付方式</text>
        <radio-group class="payment-methods" bindchange="selectPaymentMethod">
          <label class="payment-method-item" wx:for="{{paymentMethods}}" wx:key="value">
            <radio value="{{item.value}}" checked="{{item.value === selectedPaymentMethod}}" />
            <text>{{item.label}}</text>
          </label>
        </radio-group>
      </view>
      
      <view class="form-group" wx:if="{{selectedPaymentMethod === 'bank'}}">
        <text class="form-label">银行转账信息</text>
        <textarea 
          class="form-textarea" 
          placeholder="请输入银行转账的相关信息，如交易号" 
          value="{{paymentRemark}}" 
          bindinput="inputPaymentRemark"
          maxlength="100"
        />
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="btn cancel-btn" bindtap="closePayDebtModal">取消</button>
      <button class="btn confirm-btn" bindtap="confirmPayDebt" disabled="{{!canSubmitPayment}}">确认支付</button>
    </view>
  </view>

  <!-- 账户明细弹窗 -->
  <view class="modal-mask" wx:if="{{showAccountDetail}}" bindtap="closeAccountDetail" catchtouchmove="preventTouchMove"></view>
  <view class="modal-dialog account-detail-modal" wx:if="{{showAccountDetail}}">
    <view class="modal-header">
      <text>账户明细 - {{currentFactoryName}}</text>
      <view class="close-btn" bindtap="closeAccountDetail">×</view>
    </view>
    
    <view class="modal-content account-detail-content">
      <view wx:if="{{accountRecords.length === 0 && !isLoadingRecords}}" class="empty-account-detail">
        <text>暂无账户记录</text>
      </view>
      <view wx:elif="{{isLoadingRecords}}" class="loading-account-records">
        <view class="loading-icon"></view>
        <text>加载中...</text>
      </view>
      <scroll-view wx:else class="account-scroll-view" scroll-y="true">
        <scroll-view class="account-scroll-view-horizontal" scroll-x="true" enhanced="true" show-scrollbar="false">
          <view class="account-table-container">
            <view class="account-detail-list">
              <view class="account-detail-item header">
                <text class="account-date">日期</text>
                <text class="account-orderNo">收回单号</text>
                <text class="account-fee">工费</text>
                <text class="account-pay-amount">支付金额</text>
                <text class="account-pay-method">支付方式</text>
                <text class="account-balance">累计结余</text>
              </view>
              <view wx:for="{{accountRecords}}" wx:key="index" class="account-detail-item">
                <text class="account-date">{{item.date}}</text>
                <text class="account-orderNo">{{item.orderNo || '-'}}</text>
                <text class="account-fee">￥{{item.fee || 0}}</text>
                <text class="account-pay-amount {{item.payAmount > 0 ? 'payment-amount' : ''}}">
                  {{item.payAmount > 0 ? '￥'+item.payAmount : '-'}}
                </text>
                <text class="account-pay-method">{{item.payMethod || '-'}}</text>
                <text class="account-balance {{item.remainBalance >= 0 ? 'payment-amount' : 'expense-amount'}}">
                  <block wx:if="{{item.remainBalance > 0}}">
                    余款 ￥{{item.remainBalance}}
                  </block>
                  <block wx:elif="{{item.remainBalance < 0}}">
                    欠款 ￥{{-item.remainBalance}}
                  </block>
                  <block wx:else>
                    ￥0
                  </block>
                </text>
              </view>
            </view>
          </view>
        </scroll-view>
      </scroll-view>
    </view>
    
    <view class="modal-footer">
      <button class="btn confirm-btn ios-btn" bindtap="closeAccountDetail">关闭</button>
    </view>
  </view>
</view>