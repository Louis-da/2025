<!-- äº‘åŠ©ç† -->
<view class="ai-assistant-gradient-bg">
  <view class="ai-assistant-container">
    <!-- å¼‚å¸¸è­¦æŠ¥æ¨¡å—ï¼ˆæŸè€—ç‡æ’è¡Œæ¦œï¼‰ -->
    <view class="module-card alert-module">
      <view class="module-header">
        <view class="module-icon alert-icon">âš ï¸</view>
        <text class="module-title loss-title">æŸè€—æ’è¡Œ</text>
        <view class="header-right">
          <!-- æ—¶é—´ç­›é€‰æŒ‰é’®ç»„ -->
          <view class="time-filter-container">
            <view class="time-filter-buttons">
              <text class="time-filter-btn {{timeFilterType === 'today' ? 'active' : ''}}" bindtap="selectTimeFilter" data-type="today">æœ¬æ—¥</text>
              <text class="time-filter-btn {{timeFilterType === 'week' ? 'active' : ''}}" bindtap="selectTimeFilter" data-type="week">æœ¬å‘¨</text>
              <text class="time-filter-btn {{timeFilterType === 'month' ? 'active' : ''}}" bindtap="selectTimeFilter" data-type="month">æœ¬æœˆ</text>
              <text class="time-filter-btn {{timeFilterType === 'year' ? 'active' : ''}}" bindtap="selectTimeFilter" data-type="year">æœ¬å¹´</text>
              <text class="time-filter-btn custom {{timeFilterType === 'custom' ? 'active' : ''}}" bindtap="showCustomTimeFilter">è‡ªå®šä¹‰</text>
            </view>
          </view>
          <!-- åŸæœ‰çš„æ¨¡å¼åˆ‡æ¢ -->
          <view class="mode-switch" bindtap="switchLossRankingMode">
            <text class="mode-text">{{lossRankingMode === 'product' ? 'è´§å“æ¨¡å¼' : 'å·¥å‚æ¨¡å¼'}}</text>
            <text class="switch-icon">â‡„</text>
          </view>
        </view>
        <view class="bottom-info">
          <text class="count-text" wx:if="{{alertCount > 0}}">{{alertCount}}</text>
          <text class="rule-text">{{lossRankingMode === 'product' ? 'æŒ‰è´§å“ç»Ÿè®¡æŸè€—ç‡ï¼Œâ‰¥2%æˆ–â‰¤-2%æ˜¾ç¤º' : 'æŒ‰å·¥å‚ç»Ÿè®¡æŸè€—ç‡ï¼Œâ‰¥2%æˆ–â‰¤-2%æ˜¾ç¤º'}}</text>
        </view>
      </view>
      
      <view class="module-content">
        <view wx:if="{{alerts.length > 0}}" class="alert-list">
          <!-- è´§å“æ¨¡å¼ -->
          <block wx:if="{{lossRankingMode === 'product'}}">
            <view class="alert-item {{item.level}}" wx:for="{{alerts}}" wx:key="id">
              <view class="rank-indicator">
                <text class="rank-number">{{item.rank}}</text>
              </view>
              <view class="product-image-container">
                <image 
                  class="product-image" 
                  src="{{item.productImage || '/images/default-product.png'}}" 
                  mode="aspectFill"
                  lazy-load="true"
                  binderror="onImageError"
                  data-index="{{index}}"
                />
              </view>
              <view class="alert-content">
                <view class="product-info">
                  <text class="product-no">{{item.productNo}}</text>
                  <text class="product-name small">{{item.productName}}</text>
                  <text class="loss-rate {{item.level}}">{{item.lossRate}}%</text>
                </view>
                <view class="weight-info-row">
                  <text class="weight-item">å‘å‡º: {{item.totalSendWeight}}kg</text>
                  <text class="weight-item">æ”¶å›: {{item.totalReceiveWeight}}kg</text>
                  <text class="weight-item loss">å·®å€¼: {{item.totalLossWeight}}kg</text>
                </view>
                <view class="factory-bottom-row">
                  <text class="alert-time">{{item.time}}</text>
                  <text class="factory-count" bindtap="showFactoryDetail" data-item="{{item}}">{{item.factoryCount}}ä¸ªå·¥å‚</text>
                </view>
              </view>
            </view>
          </block>
          
          <!-- å·¥å‚æ¨¡å¼ -->
          <block wx:else>
            <view class="alert-item {{item.level}}" wx:for="{{alerts}}" wx:key="id">
              <view class="rank-indicator">
                <text class="rank-number">{{item.rank}}</text>
              </view>
              <view class="factory-icon-container">
                <view class="factory-icon">ğŸ­</view>
              </view>
              <view class="alert-content">
                <view class="product-info">
                  <text class="product-no">{{item.process}}</text>
                  <text class="product-name factory-mode-factory-name">{{item.factoryName}}</text>
                  <text class="loss-rate {{item.level}}">{{item.lossRate}}%</text>
                </view>
                <view class="weight-info-row">
                  <text class="weight-item">å‘å‡º: {{item.totalSendWeight}}kg</text>
                  <text class="weight-item">æ”¶å›: {{item.totalReceiveWeight}}kg</text>
                  <text class="weight-item loss">å·®å€¼: {{item.totalLossWeight}}kg</text>
                </view>
                <view class="factory-bottom-row">
                  <text class="alert-time">{{item.time}}</text>
                  <text class="product-count" bindtap="showProductDetail" data-item="{{item}}">{{item.productCount}}ä¸ªè´§å“</text>
                </view>
              </view>
            </view>
          </block>
        </view>
        
        <view wx:else class="empty-state">
          <view class="empty-icon">ğŸ¯</view>
          <text class="empty-text">æš‚æ— æŸè€—å¼‚å¸¸</text>
          <text class="empty-desc">æ‰€æœ‰è´§å“æŸè€—ç‡æ­£å¸¸</text>
        </view>
      </view>
    </view>

    <!-- æ´»è·ƒæ’è¡Œæ¨¡å— -->
    <view class="module-card trend-module">
      <view class="module-header">
        <view class="module-icon trend-icon">ğŸ¤–</view>
        <text class="module-title trend-title">æ´»è·ƒæ’è¡Œ</text>
        <view class="header-right">
          <!-- æ—¶é—´ç­›é€‰æŒ‰é’®ç»„ -->
          <view class="time-filter-container">
            <view class="time-filter-buttons">
              <text class="time-filter-btn {{activeTimeFilterType === 'today' ? 'active' : ''}}" bindtap="selectActiveTimeFilter" data-type="today">æœ¬æ—¥</text>
              <text class="time-filter-btn {{activeTimeFilterType === 'week' ? 'active' : ''}}" bindtap="selectActiveTimeFilter" data-type="week">æœ¬å‘¨</text>
              <text class="time-filter-btn {{activeTimeFilterType === 'month' ? 'active' : ''}}" bindtap="selectActiveTimeFilter" data-type="month">æœ¬æœˆ</text>
              <text class="time-filter-btn {{activeTimeFilterType === 'year' ? 'active' : ''}}" bindtap="selectActiveTimeFilter" data-type="year">æœ¬å¹´</text>
              <text class="time-filter-btn custom {{activeTimeFilterType === 'custom' ? 'active' : ''}}" bindtap="showActiveCustomTimeFilter">è‡ªå®šä¹‰</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="module-content">
        <!-- æ´»è·ƒè´§å“æ’è¡Œ -->
        <view class="active-section">
          <view class="section-header">
            <view class="section-title-row">
              <text class="section-title">ğŸ“¦ æ´»è·ƒè´§å“</text>
              <text class="section-count">TOP {{activeProducts.length > 5 ? 5 : activeProducts.length}}</text>
            </view>
            <text class="section-desc">{{activeTimeFilterType === 'today' ? 'ä»Šæ—¥' : activeTimeFilterType === 'week' ? 'æœ¬å‘¨' : activeTimeFilterType === 'month' ? 'æœ¬æœˆ' : activeTimeFilterType === 'year' ? 'æœ¬å¹´' : 'è‡ªå®šä¹‰æ—¶é—´'}}ç§‘å­¦æ´»è·ƒåº¦æ’è¡Œ</text>
          </view>
          <view class="active-list">
            <view wx:for="{{activeProducts}}" wx:key="product_no" class="active-item" wx:if="{{index < 5}}">
              <view class="rank-badge">
                <text class="rank-number">{{index + 1}}</text>
              </view>
              <view class="active-item-header">
                <image src="{{item.productImage ? item.productImage : '/images/default-product.png'}}" class="active-item-image" mode="aspectFill"></image>
                <view class="active-item-info">
                  <text class="active-item-title">{{item.product_no}}</text>
                  <text class="active-item-subtitle">{{item.productName || 'æœªçŸ¥è´§å“'}}</text>
                </view>
                <view class="active-item-score">
                  <text class="score-value">{{item.activityScore || 0}}</text>
                  <text class="score-label">æ´»è·ƒåº¦</text>
                </view>
              </view>
              
              <!-- ç§‘å­¦æŒ‡æ ‡å±•ç¤º -->
              <view class="scientific-metrics">
                <view class="metric-group">
                  <view class="metric-item">
                    <text class="metric-label">å‘å‡º</text>
                    <text class="metric-value">{{item.sendOrderCount || 0}}å• {{item.totalSendWeight || 0}}kg</text>
                  </view>
                  <view class="metric-item">
                    <text class="metric-label">æ”¶å›</text>
                    <text class="metric-value">{{item.receiveOrderCount || 0}}å• {{item.totalReceiveWeight || 0}}kg</text>
                  </view>
                </view>
                
                <view class="completion-bar">
                  <view class="completion-info">
                    <text class="completion-label">å®Œæˆç‡</text>
                    <text class="completion-percent">{{item.completionRate || 0}}%</text>
                  </view>
                  <view class="progress-bar">
                    <view class="progress-fill" style="width: {{Math.min(item.completionRate || 0, 100)}}%"></view>
                  </view>
                </view>
              </view>
              
              <view class="active-item-details">
                <text class="detail-text">æ€»äº¤æ˜“: {{item.recordCount || 0}}ç¬”</text>
                <text class="detail-text">æ¶‰åŠå·¥å‚: {{item.factoryCount || 0}}ä¸ª</text>
                <text class="detail-text">æœ€è¿‘æ´»è·ƒ: {{item.lastActiveText || 'æœªçŸ¥'}}</text>
              </view>
            </view>
          </view>
          <view class="section-footer" wx:if="{{activeProducts.length === 0}}">
            <text class="empty-hint">æš‚æ— æ´»è·ƒè´§å“æ•°æ®</text>
          </view>
        </view>

        <!-- æ´»è·ƒå·¥å‚æ’è¡Œ -->
        <view class="active-section">
          <view class="section-header">
            <view class="section-title-row">
              <text class="section-title">ğŸ­ æ´»è·ƒå·¥å‚</text>
              <text class="section-count">TOP {{activeFactories.length > 5 ? 5 : activeFactories.length}}</text>
            </view>
            <text class="section-desc">{{activeTimeFilterType === 'today' ? 'ä»Šæ—¥' : activeTimeFilterType === 'week' ? 'æœ¬å‘¨' : activeTimeFilterType === 'month' ? 'æœ¬æœˆ' : activeTimeFilterType === 'year' ? 'æœ¬å¹´' : 'è‡ªå®šä¹‰æ—¶é—´'}}ç§‘å­¦æ´»è·ƒåº¦æ’è¡Œ</text>
          </view>
          <view class="active-list">
            <view wx:for="{{activeFactories}}" wx:key="factory_id" class="active-item" wx:if="{{index < 5}}">
              <view class="rank-badge">
                <text class="rank-number">{{index + 1}}</text>
              </view>
              <view class="active-item-header">
                <view class="factory-icon">ğŸ­</view>
                <view class="active-item-info">
                  <text class="active-item-title">{{item.factoryName}}</text>
                  <text class="active-item-subtitle"></text>
                </view>
                <view class="active-item-score">
                  <text class="score-value">{{item.activityScore || 0}}</text>
                  <text class="score-label">æ´»è·ƒåº¦</text>
                </view>
              </view>
              
              <!-- ç§‘å­¦æŒ‡æ ‡å±•ç¤º -->
              <view class="scientific-metrics">
                <view class="metric-group">
                  <view class="metric-item">
                    <text class="metric-label">å‘å‡º</text>
                    <text class="metric-value">{{item.sendOrderCount || 0}}å• {{item.totalSendWeight || 0}}kg</text>
                  </view>
                  <view class="metric-item">
                    <text class="metric-label">æ”¶å›</text>
                    <text class="metric-value">{{item.receiveOrderCount || 0}}å• {{item.totalReceiveWeight || 0}}kg</text>
                  </view>
                </view>
                
                <view class="completion-bar">
                  <view class="completion-info">
                    <text class="completion-label">å®Œæˆç‡</text>
                    <text class="completion-percent">{{item.completionRate || 0}}%</text>
                  </view>
                  <view class="progress-bar">
                    <view class="progress-fill" style="width: {{Math.min(item.completionRate || 0, 100)}}%"></view>
                  </view>
                </view>
              </view>
              
              <view class="active-item-details">
                <text class="detail-text">æ€»äº¤æ˜“: {{item.recordCount || 0}}ç¬”</text>
                <text class="detail-text">æ¶‰åŠè´§å“: {{item.productCount || 0}}ç§</text>
                <text class="detail-text">æœ€è¿‘æ´»è·ƒ: {{item.lastActiveText || 'æœªçŸ¥'}}</text>
              </view>
            </view>
          </view>
          <view class="section-footer" wx:if="{{activeFactories.length === 0}}">
            <text class="empty-hint">æš‚æ— æ´»è·ƒå·¥å‚æ•°æ®</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åˆ·æ–°æŒ‰é’® -->
    <view class="refresh-section">
      <button class="refresh-btn" bindtap="refreshData">
        <text class="refresh-icon">ğŸ”„</text>
        <text>åˆ·æ–°æ•°æ®</text>
      </button>
    </view>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <view class="detail-modal" wx:if="{{showDetailModal}}" bindtap="hideDetailModal">
      <view class="modal-content" catchtap="stopPropagation">
        <view class="modal-header">
          <text class="modal-title">{{detailModalTitle}}</text>
          <text class="modal-close" bindtap="hideDetailModal">âœ•</text>
        </view>
        <scroll-view class="modal-body" scroll-y="true">
          <view class="detail-item" wx:for="{{detailList}}" wx:key="id">
            <view class="detail-rank">{{index + 1}}</view>
            <view class="detail-content">
              <view class="detail-name">{{item.name}}</view>
              <view class="detail-info">
                <text class="detail-loss-rate {{item.level}}">{{item.lossRate}}%</text>
                <text class="detail-weight">å‘å‡º: {{item.sendWeight}}kg</text>
                <text class="detail-weight">æ”¶å›: {{item.receiveWeight}}kg</text>
              </view>
            </view>
          </view>
        </scroll-view>
      </view>
    </view>

    <!-- è‡ªå®šä¹‰æ—¶é—´ç­›é€‰å¼¹çª— -->
    <view class="time-filter-modal" wx:if="{{showCustomTimeModal}}" bindtap="hideCustomTimeFilter">
      <view class="time-modal-content" catchtap="stopPropagation">
        <view class="time-modal-header">
          <text class="time-modal-title">è‡ªå®šä¹‰æ—¶é—´èŒƒå›´</text>
          <text class="time-modal-close" bindtap="hideCustomTimeFilter">âœ•</text>
        </view>
        <view class="time-modal-body">
          <view class="time-input-section">
            <view class="time-input-group">
              <text class="time-label">å¼€å§‹æ—¥æœŸ</text>
              <picker mode="date" value="{{customStartDate}}" bindchange="onCustomStartDateChange">
                <view class="time-picker">{{customStartDate || 'é€‰æ‹©å¼€å§‹æ—¥æœŸ'}}</view>
              </picker>
            </view>
            <view class="time-input-group">
              <text class="time-label">ç»“æŸæ—¥æœŸ</text>
              <picker mode="date" value="{{customEndDate}}" bindchange="onCustomEndDateChange">
                <view class="time-picker">{{customEndDate || 'é€‰æ‹©ç»“æŸæ—¥æœŸ'}}</view>
              </picker>
            </view>
          </view>
          <view class="time-modal-footer">
            <button class="time-cancel-btn" bindtap="hideCustomTimeFilter">å–æ¶ˆ</button>
            <button class="time-confirm-btn" bindtap="confirmCustomTimeFilter">ç¡®å®š</button>
          </view>
        </view>
      </view>
    </view>

    <!-- æ´»è·ƒæ’è¡Œè‡ªå®šä¹‰æ—¶é—´ç­›é€‰å¼¹çª— -->
    <view class="time-filter-modal" wx:if="{{showActiveCustomTimeModal}}" bindtap="hideActiveCustomTimeFilter">
      <view class="time-modal-content" catchtap="stopPropagation">
        <view class="time-modal-header">
          <text class="time-modal-title">æ´»è·ƒæ’è¡Œ - è‡ªå®šä¹‰æ—¶é—´èŒƒå›´</text>
          <text class="time-modal-close" bindtap="hideActiveCustomTimeFilter">âœ•</text>
        </view>
        <view class="time-modal-body">
          <view class="time-input-section">
            <view class="time-input-group">
              <text class="time-label">å¼€å§‹æ—¥æœŸ</text>
              <picker mode="date" value="{{activeCustomStartDate}}" bindchange="onActiveCustomStartDateChange">
                <view class="time-picker">{{activeCustomStartDate || 'é€‰æ‹©å¼€å§‹æ—¥æœŸ'}}</view>
              </picker>
            </view>
            <view class="time-input-group">
              <text class="time-label">ç»“æŸæ—¥æœŸ</text>
              <picker mode="date" value="{{activeCustomEndDate}}" bindchange="onActiveCustomEndDateChange">
                <view class="time-picker">{{activeCustomEndDate || 'é€‰æ‹©ç»“æŸæ—¥æœŸ'}}</view>
              </picker>
            </view>
          </view>
          <view class="time-modal-footer">
            <button class="time-cancel-btn" bindtap="hideActiveCustomTimeFilter">å–æ¶ˆ</button>
            <button class="time-confirm-btn" bindtap="confirmActiveCustomTimeFilter">ç¡®å®š</button>
          </view>
        </view>
      </view>
    </view>
  </view>
</view> 