<view class="send-order-page-container">

  <!-- åŸºç¡€ä¿¡æ¯å¡ç‰‡ -->
  <view class="card">
    <view class="section-title">åŸºç¡€ä¿¡æ¯</view>
    <view wx:if="{{mode === 'view'}}">
      <view class="combined-row">
        <view class="combined-item">
          <view class="item-label">å·¥å‚</view>
          <view class="item-value">{{selectedFactory.name || '-'}}</view>
        </view>
        <view class="combined-item">
          <view class="item-label">å·¥åº</view>
          <view class="item-value">{{selectedProcess.name || selectedProcess || '-'}}</view>
        </view>
      </view>
    </view>
    <view wx:if="{{mode !== 'view'}}">
      <view class="form-row">
        <view class="form-col">
          <view class="form-label required">å·¥å‚</view>
          <view class="factory-dropdown-container">
            <view class="factory-search-input-wrapper">
              <input 
                class="form-value apple-input {{selectedFactory ? '' : 'placeholder'}}" 
                placeholder="è¾“å…¥å·¥å‚åç§°æˆ–é¦–å­—æ¯"
                value="{{factorySearchKeyword}}"
                bindinput="onFactorySearch"
                bindtap="showFactoryDropdown"
                bindfocus="showFactoryDropdown"
                bindblur="hideFactoryDropdownWithDelay"
                confirm-type="search"
              />
            </view>
            <!-- è‹¹æœç®€çº¦é£ä¸‹æ‹‰åˆ—è¡¨ -->
            <view class="factory-dropdown {{showFactoryDropdown ? 'show' : ''}}" wx:if="{{showFactoryDropdown}}">
              <scroll-view class="dropdown-scroll" scroll-y="true">
                <view wx:if="{{filteredFactories.length === 0}}" class="dropdown-empty">
                  <view class="empty-icon">ğŸ­</view>
                  <view class="empty-text">æœªæ‰¾åˆ°ç›¸å…³å·¥å‚</view>
                </view>
                <view wx:else class="factory-dropdown-list">
                  <view 
                    class="factory-dropdown-item {{selectedFactory && selectedFactory.id === item.id ? 'selected' : ''}}" 
                    wx:for="{{filteredFactories}}" 
                    wx:key="id" 
                    catchtap="selectFactoryFromDropdown" 
                    data-factory="{{item}}"
                  >
                    <view class="factory-info">
                      <view class="factory-name">{{item.name}}</view>
                      <view class="factory-details" wx:if="{{item.phone || item.address}}">
                        <text class="factory-phone" wx:if="{{item.phone}}">ğŸ“ {{item.phone}}</text>
                        <text class="factory-address" wx:if="{{item.address}}">ğŸ“ {{item.address}}</text>
                      </view>
                    </view>
                    <view class="check-mark" wx:if="{{selectedFactory && selectedFactory.id === item.id}}">âœ“</view>
                  </view>
                </view>
              </scroll-view>
            </view>
          </view>
          <view class="selected-factory-display" wx:if="{{selectedFactory}}">
            å·²é€‰æ‹©ï¼š{{selectedFactory.name}}
          </view>
        </view>
        <view class="form-col">
          <view class="form-label required">å·¥åº</view>
          <picker bindchange="selectProcess" range="{{processes}}" range-key="name">
            <view class="form-value apple-input {{selectedProcess ? '' : 'placeholder'}}">
              {{selectedProcess.name || selectedProcess || 'è¯·é€‰æ‹©'}}
              <view class="picker-arrow"></view>
            </view>
          </picker>
        </view>
      </view>
    </view>
  </view>

  <!-- è´§å“ä¿¡æ¯å¡ç‰‡ -->
  <view class="card">
    <view class="section-title">è´§å“ä¿¡æ¯</view>
    <view class="product-action-bar product-action-bar-centered" wx:if="{{mode !== 'view'}}">
      <button class="add-product-btn apple-btn" bindtap="showProductSelect">æ·»åŠ è´§å“</button>
    </view>
    <view class="product-list">
      <block wx:if="{{selectedProducts && selectedProducts.length > 0}}">
        <view class="product-item" wx:for="{{selectedProducts}}" wx:key="index">
          <view class="product-info">
            <image class="product-image" src="{{item.image || '/images/default-product.png'}}" mode="aspectFill" binderror="onImageError" data-index="{{index}}"></image>
            <view class="product-details">
              <view class="product-code">è´§å·: {{item.productNo || item.code || '-'}}</view>
              <view class="product-name">{{item.name || '-'}}</view>
              <view class="product-tags">
                <view class="product-tag" wx:if="{{item.color}}">
                  <text class="tag-name">é¢œè‰²:</text>
                  <text class="tag-value">{{item.color}}</text>
                </view>
                <view class="product-tag" wx:if="{{item.size}}">
                  <text class="tag-name">å°ºç :</text>
                  <text class="tag-value">{{item.size}}</text>
                </view>
                <view class="product-actions-inline" wx:if="{{mode !== 'view'}}">
                  <button class="btn-same-product apple-btn" bindtap="addSameProduct" data-index="{{index}}">+</button>
                  <button class="btn-small btn-danger apple-btn" bindtap="deleteProduct" data-index="{{index}}">-</button>
                </view>
              </view>
            </view>
          </view>
          <view class="product-controls">
            <view class="quantity-weight">
              <view class="control-item">
                <text class="control-label {{tempWeight && parseFloat(tempWeight) > 0 ? '' : 'required'}}">æ•°é‡:</text>
                <input wx:if="{{mode !== 'view'}}" class="control-input apple-input" type="digit" value="{{item.quantity}}" bindinput="bindQuantityInput" data-index="{{index}}" />
                <view wx:else class="control-value-container">
                  <text class="control-value">{{item.quantity}}</text>
                  <text class="control-unit">æ‰“</text>
                </view>
              </view>
              <view class="control-item">
                <text class="control-label">é‡é‡:</text>
                <input wx:if="{{mode !== 'view'}}" class="control-input apple-input" type="digit" value="{{item.weight}}" bindinput="bindWeightInput" data-index="{{index}}" />
                <view wx:else class="control-value-container">
                  <text class="control-value">{{item.weight}}</text>
                  <text class="control-unit">kg</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </block>
      <view wx:else class="no-products">
        <text>æš‚æ— è´§å“ï¼Œè¯·æ·»åŠ </text>
      </view>
    </view>
    <view class="product-totals">
      <view class="total-item">
        <text class="total-label">æ€»æ•°é‡: </text>
        <text class="total-value">{{totalQuantity || 0}}</text>
        <text class="total-unit">æ‰“</text>
      </view>
      <view class="total-item">
        <text class="total-label">æ€»é‡é‡: </text>
        <text class="total-value">{{totalWeight || 0}}</text>
        <text class="total-unit">kg</text>
      </view>
    </view>
  </view>

  <!-- å¤‡æ³¨åŠç…§ç‰‡å¡ç‰‡ -->
  <view class="card">
    <view class="section-title">å¤‡æ³¨åŠç…§ç‰‡</view>
    <view class="creator-info" style="display: flex; flex-direction: row; justify-content: space-between; align-items: center;">
      <text class="creator-info-text">åˆ¶å•äºº:{{staff || '-'}} </text>
      <text class="creator-info-text" style="margin-left:auto;">åˆ¶å•æ—¶é—´:{{date || '-'}} </text>
    </view>
    <view class="form-group">
      <view class="form-label">å¤‡æ³¨</view>
      <view class="form-value" wx:if="{{mode === 'view'}}">
        {{remark || 'æ— å¤‡æ³¨'}}
      </view>
      <view wx:if="{{mode === 'view' && remarkImages && remarkImages.length > 0}}" class="remark-photos-section">
        <view class="form-label">å¤‡æ³¨ç…§ç‰‡</view>
        <view class="remark-photos">
          <image wx:for="{{remarkImages}}" wx:key="index" src="{{item}}" mode="aspectFill" class="remark-photo" bindtap="previewRemarkImage" data-index="{{index}}"></image>
        </view>
      </view>
      <block wx:else>
        <textarea class="form-textarea apple-input" placeholder="è¾“å…¥å¤‡æ³¨ä¿¡æ¯" bindinput="inputRemark" value="{{remark}}" />
        <view class="remark-photo-upload">
          <view class="photo-list">
            <view class="photo-item" wx:for="{{remarkPhotos}}" wx:key="index">
              <image src="{{item}}" mode="aspectFill" class="photo-preview"></image>
              <view class="photo-delete" bindtap="deleteRemarkPhoto" data-index="{{index}}">Ã—</view>
            </view>
            <view class="photo-upload-btn" bindtap="chooseRemarkPhoto" wx:if="{{remarkPhotos.length < 3}}">
              <view class="upload-icon">+</view>
              <view class="upload-text">ç…§ç‰‡</view>
            </view>
          </view>
          <view class="photo-tip">æœ€å¤šä¸Šä¼ 3å¼ ç…§ç‰‡</view>
        </view>
      </block>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="footer-actions">
    <button class="btn-primary apple-btn" bindtap="submitOrder" wx:if="{{mode !== 'view'}}">{{mode === 'edit' ? 'ä¿å­˜è®¢å•' : 'ä¿å­˜'}}</button>
    <button class="btn-default apple-btn" bindtap="cancelOrder" wx:if="{{mode === 'view' && orderStatus !== 0}}">ä½œåºŸ</button>
    <button class="btn-default apple-btn" bindtap="navigateBack">è¿”å›</button>
  </view>

  <!-- è´§å“é€‰æ‹©å¼¹çª— -->
  <view class="product-modal {{showProductModal ? 'show' : ''}}" wx:if="{{showProductModal}}">
    <view class="modal-mask" bindtap="hideProductSelect"></view>
    <view class="modal-content card">
      <view class="modal-header">
        <text class="modal-title">é€‰æ‹©è´§å“</text>
        <text class="modal-close" bindtap="hideProductSelect">Ã—</text>
      </view>
      <view class="modal-search">
        <input class="apple-input" placeholder="æœç´¢è´§å“ç¼–å·æˆ–åç§°" value="{{productSearchKeyword}}" bindinput="searchProducts" />
      </view>
      <scroll-view class="modal-body" scroll-y="true">
        <view wx:if="{{filteredProducts.length === 0}}" class="empty-search">
          <view class="empty-text">æœªæ‰¾åˆ°ç›¸å…³è´§å“</view>
        </view>
        <view wx:else class="product-select-list">
          <view class="card list-item-override" wx:for="{{filteredProducts}}" wx:key="id" bindtap="selectProduct" data-index="{{index}}">
            <view class="list-item-content">
              <image class="list-item-image" src="{{item.image || '/images/default-product.png'}}" mode="aspectFill"></image>
              <view class="list-item-details">
                <view class="list-item-code">{{item.productNo}}</view>
                <view class="list-item-name">{{item.name}}</view>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

</view>

<!-- è´§å“ç¡®è®¤æ·»åŠ å¼¹çª— -->
<view class="product-confirm-modal {{selectedProductTemp ? 'show' : ''}}" wx:if="{{selectedProductTemp}}">
  <view class="modal-mask" bindtap="hideProductSelect"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">æ·»åŠ è´§å“</text>
      <text class="modal-close" bindtap="hideProductSelect">Ã—</text>
    </view>
    
    <view class="modal-body">
      <view class="selected-product">
        <image class="product-image" src="{{selectedProductTemp.image || '/images/default-product.png'}}" mode="aspectFill"></image>
        <view class="product-details">
          <view class="product-code">è´§å·: {{selectedProductTemp.productNo}}</view>
          <view class="product-name">{{selectedProductTemp.name}}</view>
        </view>
      </view>
      
      <view class="product-edit-form">
        <!-- é¢œè‰²å’Œå°ºç é€‰æ‹©ï¼ˆåŒæ­¥è´§å“ä¿¡æ¯ï¼‰ -->
        <view class="form-row">
          <view class="form-col">
            <text class="edit-form-label">é¢œè‰²</text>
            <picker
              bindchange="bindTempColorPicker"
              range="{{selectedProductTemp.colorOptions}}"
              value="{{selectedProductTemp.colorIndex}}"
            >
              <view class="edit-form-value {{tempColor ? '' : 'placeholder'}}">
                {{tempColor || 'è¯·é€‰æ‹©é¢œè‰²'}}
                <view class="picker-arrow"></view>
              </view>
            </picker>
          </view>
          <view class="form-col">
            <text class="edit-form-label">å°ºç </text>
            <picker
              bindchange="bindTempSizePicker"
              range="{{selectedProductTemp.sizeOptions}}"
              value="{{selectedProductTemp.sizeIndex}}"
            >
              <view class="edit-form-value {{tempSize ? '' : 'placeholder'}}">
                {{tempSize || 'è¯·é€‰æ‹©å°ºç '}}
                <view class="picker-arrow"></view>
              </view>
            </picker>
          </view>
        </view>
        <!-- åŸæœ‰æ•°é‡å’Œé‡é‡è¾“å…¥è¡Œ -->
        <view class="form-row">
          <!-- Quantity Input -->
          <view class="form-col">
            <text class="edit-form-label {{tempWeight && parseFloat(tempWeight) > 0 ? '' : 'required'}}">æ•°é‡(æ‰“)</text>
            <input class="quantity-input" type="digit" placeholder="è¯·è¾“å…¥æ•°é‡" bindinput="bindTempQuantityInput" value="{{tempQuantity}}" focus/>
          </view>

          <!-- é‡é‡è¾“å…¥ -->
          <view class="form-col">
            <text class="edit-form-label">é‡é‡</text>
            <input class="weight-input" type="digit" placeholder="è¯·è¾“å…¥é‡é‡" bindinput="bindTempWeightInput" value="{{tempWeight}}"/>
          </view>
        </view>
      </view>
      
      <view class="modal-actions">
        <!-- æ·»åŠ å¹¶ç»§ç»­æŒ‰é’®æ”¹ä¸º+å·å›¾æ ‡æŒ‰é’®ï¼Œå±…ä¸­æ˜¾ç¤º -->
        <view class="btn-add-continue" hover-class="btn-hover" bindtap="addSelectedProductAndContinue">+</view>
        <!-- ç¡®è®¤æ·»åŠ å’Œå–æ¶ˆæŒ‰é’®é‡‡ç”¨å…¨å®½æ ·å¼ -->
        <button class="btn-primary full-width-btn" hover-class="btn-hover" bindtap="addSelectedProduct">ç¡®è®¤æ·»åŠ </button>
        <button class="btn-default full-width-btn" hover-class="btn-hover" bindtap="hideProductSelect">å–æ¶ˆ</button>
      </view>
    </view>
  </view>
</view>

<!-- å¯¼å‡ºå›¾ç‰‡æ—¶çš„éšè—canvas -->
<canvas type="2d" id="shareCanvas" style="width: {{canvasWidth}}px; height: {{canvasHeight}}px; position: fixed; top: -9999px;" id="shareCanvas"></canvas>

<!-- å›¾ç‰‡åˆ†äº«å¼¹çª— -->
<view class="modal-mask" wx:if="{{showShareModalFlag}}" bindtap="hideShareModal" catchtouchmove="preventTouchMove"></view>
<view class="modal-dialog share-dialog" wx:if="{{showShareModalFlag}}">
  <view class="modal-header">
    <text>å‘å‡ºå•åˆ†äº«</text>
    <view class="close-btn" bindtap="hideShareModal">Ã—</view>
  </view>
  
  <view class="modal-content">
    <view class="share-preview">
      <image class="share-image" src="{{shareImagePath}}" mode="widthFix"></image>
    </view>
    <view class="share-tips">å•æ®å·²å®Œæˆï¼Œè¯·é€‰æ‹©ä¿å­˜å›¾ç‰‡æˆ–åˆ†äº«ç»™å¥½å‹</view>
  </view>
  
  <view class="modal-footer">
    <button class="btn cancel-btn" bindtap="hideShareModal">è¿”å›</button>
    <button class="btn save-btn" bindtap="saveImageToAlbum">ä¿å­˜å›¾ç‰‡</button>
    <button class="btn confirm-btn" open-type="share">åˆ†äº«ç»™å¥½å‹</button>
  </view>
</view>