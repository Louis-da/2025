<wxs module="filter">
module.exports = {
  formatDate: function(dateStr) {
    if (!dateStr) return '';
    return dateStr.split(' ')[0]; // åªå–æ—¥æœŸéƒ¨åˆ†
  },
  calculateTotal: function(orders, field) {
    if (!orders) return 0;
    var total = 0;
    for (var i = 0; i < orders.length; i++) {
      total += parseFloat(orders[i][field] || 0);
    }
    return total.toFixed(2);
  },
  calculateQtyTotal: function(orders, field) {
    if (!orders) return 0;
    var total = 0;
    for (var i = 0; i < orders.length; i++) {
      total += parseInt(orders[i][field] || 0);
    }
    return total;
  },
  calculateLossWeight: function(sendOrders, receiveOrders) {
    var sendWeight = 0;
    var receiveWeight = 0;
    
    if (sendOrders) {
      for (var i = 0; i < sendOrders.length; i++) {
        sendWeight += parseFloat(sendOrders[i].weight || 0);
      }
    }
    
    if (receiveOrders) {
      for (var j = 0; j < receiveOrders.length; j++) {
        receiveWeight += parseFloat(receiveOrders[j].weight || 0);
      }
    }
    
    var lossWeight = sendWeight - receiveWeight;
    return lossWeight.toFixed(2);
  },
  calculateLossRate: function(sendOrders, receiveOrders) {
    var sendWeight = 0;
    var receiveWeight = 0;
    
    if (sendOrders) {
      for (var i = 0; i < sendOrders.length; i++) {
        sendWeight += parseFloat(sendOrders[i].weight || 0);
      }
    }
    
    if (receiveOrders) {
      for (var j = 0; j < receiveOrders.length; j++) {
        receiveWeight += parseFloat(receiveOrders[j].weight || 0);
      }
    }
    
    if (sendWeight === 0) return '0.00';
    
    var lossRate = ((sendWeight - receiveWeight) / sendWeight) * 100;
    return lossRate.toFixed(2);
  },
  getArrayLength: function(arr) {
    if (!arr || typeof arr !== 'object' || typeof arr.length !== 'number') return 0;
    return arr.length;
  },
  getBalanceClass: function(balance) {
    var balanceNum = parseFloat(balance || 0);
    return balanceNum > 0 ? 'highlight-red' : 'highlight-green';
  },
  getLossRateClass: function(lossRate) {
    var rate = parseFloat(lossRate || 0);
    if (rate <= 2) return 'highlight-green';
    if (rate <= 5) return 'highlight-orange';
    return 'highlight-red';
  },
  getPaymentMethodText: function(method) {
    if (!method || method.trim() === '') return 'æœªä»˜';
    var methodMap = {
      // è‹±æ–‡ç¼–ç æ˜ å°„
      'cash': 'ç°é‡‘',
      'wechat': 'å¾®ä¿¡',
      'alipay': 'æ”¯ä»˜å®', 
      'bank': 'é“¶è¡Œ',
      'unpaid': 'æœªä»˜',
      // ä¸­æ–‡ç›´æ¥æ˜ å°„
      'ç°é‡‘': 'ç°é‡‘',
      'å¾®ä¿¡': 'å¾®ä¿¡',
      'å¾®ä¿¡æ”¯ä»˜': 'å¾®ä¿¡',
      'æ”¯ä»˜å®': 'æ”¯ä»˜å®',
      'é“¶è¡Œ': 'é“¶è¡Œ',
      'é“¶è¡Œè½¬è´¦': 'é“¶è¡Œ',
      'æœªä»˜': 'æœªä»˜',
    };
    var normalizedMethod = method.trim();
    return methodMap[normalizedMethod] || normalizedMethod;
  },
  // ğŸ”§ å¤‡ç”¨è®¡ç®—å‡½æ•°ï¼šé€šè¿‡å·¥ä»·Ã—æ•°é‡è®¡ç®—å·¥è´¹ï¼ˆä»…åœ¨ç‰¹æ®Šæƒ…å†µä¸‹ä½¿ç”¨ï¼‰
  calculateFee: function(unitPrice, quantity) {
    var price = parseFloat(unitPrice || 0);
    var qty = parseInt(quantity || 0);
    return (price * qty).toFixed(2);
  },
  getFactoryName: function(selectedFactory) {
    return selectedFactory && selectedFactory.name ? selectedFactory.name : 'æœªé€‰æ‹©';
  }
};
</wxs>

<view class="container">
  <!-- æŸ¥è¯¢åŒºåŸŸ -->
  <view class="search-section">
    <view class="section-header">
      <text class="section-title">å·¥å‚å¯¹è´¦å•</text>
    </view>
    
    <view class="form-group">
      <text class="form-label">å·¥å‚</text>
      <view class="factory-dropdown-container">
        <view class="factory-search-input-wrapper">
          <input 
            class="picker-content {{selectedFactory ? 'has-value' : ''}}" 
            placeholder="è¾“å…¥å·¥å‚åç§°æˆ–é¦–å­—æ¯"
            value="{{factorySearchKeyword}}"
            bindinput="onFactorySearch"
            bindtap="showFactoryDropdown"
            bindfocus="onFactoryInputFocus"
            bindblur="hideFactoryDropdownWithDelay"
            confirm-type="search"
          />
        </view>
        <!-- è‹¹æœç®€çº¦é£ä¸‹æ‹‰åˆ—è¡¨ -->
        <view class="factory-dropdown {{showFactoryDropdown ? 'show' : ''}}" wx:if="{{showFactoryDropdown}}">
          <scroll-view class="dropdown-scroll" scroll-y="true">
            <view wx:if="{{filteredFactories.length === 0}}" class="dropdown-empty">
              <view class="empty-icon">ğŸ­</view>
              <view class="empty-text">æœªæ‰¾åˆ°ç›¸å…³å·¥å‚</view>
            </view>
            <view wx:else class="factory-dropdown-list">
              <view 
                class="factory-dropdown-item {{selectedFactory && selectedFactory.id === item.id ? 'selected' : ''}}" 
                wx:for="{{filteredFactories}}" 
                wx:key="id" 
                catchtap="selectFactoryFromDropdown" 
                data-factory="{{item}}"
              >
                <view class="factory-info">
                  <view class="factory-name">{{item.name}}</view>
                  <view class="factory-details" wx:if="{{item.phone || item.address}}">
                    <text class="factory-phone" wx:if="{{item.phone}}">ğŸ“ {{item.phone}}</text>
                    <text class="factory-address" wx:if="{{item.address}}">ğŸ“ {{item.address}}</text>
                  </view>
                </view>
                <view class="check-mark" wx:if="{{selectedFactory && selectedFactory.id === item.id}}">âœ“</view>
              </view>
            </view>
          </scroll-view>
        </view>
      </view>
      <view class="selected-factory-display" wx:if="{{selectedFactory}}">
        å·²é€‰æ‹©ï¼š{{selectedFactory.name}}
      </view>
    </view>
    
    <view class="form-group">
      <text class="form-label">è´§å“</text>
      <view class="product-dropdown-container">
        <view class="product-search-input-wrapper">
          <input 
            class="picker-content {{selectedProduct ? 'has-value' : ''}}" 
            placeholder="è¾“å…¥è´§å“ç¼–å·æˆ–åç§°"
            value="{{productInputValue}}"
            bindinput="onProductSearch"
            bindtap="showProductDropdown"
            bindfocus="onProductInputFocus"
            bindblur="hideProductDropdownWithDelay"
            confirm-type="search"
          />
        </view>
        <!-- è´§å“ä¸‹æ‹‰åˆ—è¡¨ -->
        <view class="product-dropdown {{showProductDropdown ? 'show' : ''}}" catchtap="">
          <scroll-view class="dropdown-scroll" scroll-y="true">
            <view wx:if="{{filteredProducts.length === 0}}" class="dropdown-empty">
              <view class="empty-icon">ğŸ“¦</view>
              <view class="empty-text">æœªæ‰¾åˆ°ç›¸å…³è´§å“</view>
            </view>
            <view wx:else class="product-dropdown-list">
              <!-- å…¨éƒ¨è´§å“é€‰é¡¹ -->
              <view 
                class="product-dropdown-item {{!selectedProduct ? 'selected' : ''}}" 
                catchtap="selectProductFromDropdown" 
                data-product=""
              >
                <view class="product-info">
                  <view class="product-name">å…¨éƒ¨è´§å“</view>
                  <view class="product-details">
                    <text class="product-subtitle">æŸ¥çœ‹æ‰€æœ‰è´§å“çš„å¯¹è´¦ä¿¡æ¯</text>
                  </view>
                </view>
                <view class="check-mark" wx:if="{{!selectedProduct}}">âœ“</view>
              </view>
              <!-- å…·ä½“è´§å“é€‰é¡¹ -->
              <view 
                class="product-dropdown-item {{selectedProduct && selectedProduct.id === item.id ? 'selected' : ''}}" 
                wx:for="{{filteredProducts}}" 
                wx:key="id" 
                catchtap="selectProductFromDropdown" 
                data-product="{{item}}"
              >
                <view class="product-info">
                  <view class="product-name">{{item.productNo || item.code}}</view>
                  <view class="product-details" wx:if="{{item.name || item.process}}">
                    <text class="product-subtitle" wx:if="{{item.name}}">{{item.name}}</text>
                    <text class="product-process" wx:if="{{item.process}}">{{item.process}}</text>
                  </view>
                </view>
                <view class="check-mark" wx:if="{{selectedProduct && selectedProduct.id === item.id}}">âœ“</view>
              </view>
            </view>
          </scroll-view>
        </view>
      </view>
      <view class="selected-product-display" wx:if="{{selectedProduct}}">
        å·²é€‰æ‹©ï¼š{{selectedProduct.productNo || selectedProduct.code}}
      </view>
    </view>
    
    <view class="form-group date-group">
      <text class="form-label">æ—¥æœŸèŒƒå›´</text>
      <view class="date-pickers">
        <picker mode="date" value="{{startDate}}" bindchange="changeStartDate" class="date-picker">
          <view class="picker-content has-value">
            <text>{{startDate}}</text>
            <view class="picker-arrow"></view>
          </view>
        </picker>
        <view class="date-separator"></view>
        <picker mode="date" value="{{endDate}}" bindchange="changeEndDate" class="date-picker">
          <view class="picker-content has-value">
            <text>{{endDate}}</text>
            <view class="picker-arrow"></view>
          </view>
        </picker>
      </view>
    </view>
    
    <button class="search-btn" bindtap="fetchStatement">æŸ¥è¯¢å¯¹è´¦å•</button>
  </view>
  
  <!-- åŠ è½½ä¸­çŠ¶æ€ -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <view class="loading"></view>
    <text>åŠ è½½ä¸­...</text>
  </view>
  
  <!-- ç©ºçŠ¶æ€æç¤º -->
  <view wx:elif="{{!selectedFactory}}" class="empty-state">
    <image class="empty-state-image" src="/images/icons/statement.png" mode="aspectFit"></image>
    <text class="empty-state-text">è¯·é€‰æ‹©å·¥å‚æŸ¥çœ‹å¯¹è´¦å•</text>
  </view>
  
  <!-- å¯¹è´¦å•å†…å®¹ -->
  <view wx:if="{{statement && !isLoading}}" class="statement-content">
    <!-- å¯¹è´¦å•å¤´éƒ¨ä¿¡æ¯ -->
    <view class="statement-header">
      <view class="factory-info">
        <text class="factory-name">{{selectedFactory.name}}</text>
      </view>
      <view class="date-info">
        <text>å¼€å§‹æ—¥æœŸ: {{startDate}}</text>
        <text>ç»“æŸæ—¥æœŸ: {{endDate}}</text>
      </view>
      <view class="balance-info">
        <text>æœŸåˆæ¬ æ¬¾: {{statement.initialBalance || '0.00'}}</text>
        <text>æœŸæœ«æ¬ æ¬¾: {{statement.finalBalance || '0.00'}}</text>
      </view>
    </view>
    
    <!-- å¯¹è´¦æ‘˜è¦æ¨¡å— -->
    <view class="statement-summary">
      <view class="summary-header">
        <text class="summary-title">å¯¹è´¦æ‘˜è¦</text>
        <text class="summary-subtitle">{{startDate}} è‡³ {{endDate}}</text>
      </view>
      
      <view class="summary-cards">
        <!-- å‘å‡ºå•æ‘˜è¦ -->
        <view class="summary-card send-card">
          <view class="card-header">
            <view class="card-icon send-icon">å‘</view>
            <text class="card-title">å‘å‡ºå•</text>
          </view>
          <view class="card-content">
            <view class="card-item">
              <text class="item-label">å•æ®æ•°é‡</text>
              <text class="item-value">{{filter.getArrayLength(statement.sendOrders)}}å•</text>
            </view>
            <view class="card-item">
              <text class="item-label">å‘å‡ºæ•°é‡</text>
              <text class="item-value highlight-blue">{{filter.calculateQtyTotal(statement.sendOrders, 'quantity')}}æ‰“</text>
            </view>
            <view class="card-item">
              <text class="item-label">å‘å‡ºé‡é‡</text>
              <text class="item-value highlight-blue">{{filter.calculateTotal(statement.sendOrders, 'weight')}}kg</text>
            </view>
          </view>
        </view>
        
        <!-- æ”¶å›å•æ‘˜è¦ -->
        <view class="summary-card receive-card">
          <view class="card-header">
            <view class="card-icon receive-icon">æ”¶</view>
            <text class="card-title">æ”¶å›å•</text>
          </view>
          <view class="card-content">
            <view class="card-item">
              <text class="item-label">å•æ®æ•°é‡</text>
              <text class="item-value">{{filter.getArrayLength(statement.receiveOrders)}}å•</text>
            </view>
            <view class="card-item">
              <text class="item-label">æ”¶å›æ•°é‡</text>
              <text class="item-value highlight-orange">{{filter.calculateQtyTotal(statement.receiveOrders, 'quantity')}}æ‰“</text>
            </view>
            <view class="card-item">
              <text class="item-label">æ”¶å›é‡é‡</text>
              <text class="item-value highlight-orange">{{filter.calculateTotal(statement.receiveOrders, 'weight')}}kg</text>
            </view>
          </view>
        </view>
        
        <!-- æŸè€—åˆ†æ -->
        <view class="summary-card loss-card">
          <view class="card-header">
            <view class="card-icon loss-icon">æŸ</view>
            <text class="card-title">æŸè€—åˆ†æ</text>
          </view>
          <view class="card-content">
            <view class="card-item">
              <text class="item-label">æŸè€—é‡é‡</text>
              <text class="item-value highlight-red">{{filter.calculateLossWeight(statement.sendOrders, statement.receiveOrders)}}kg</text>
            </view>
            <view class="card-item">
              <text class="item-label">æŸè€—ç‡</text>
              <text class="item-value highlight-red">{{filter.calculateLossRate(statement.sendOrders, statement.receiveOrders)}}%</text>
            </view>
            <view class="card-item">
              <text class="item-label">è´§å“ç§ç±»</text>
              <text class="item-value">{{filter.getArrayLength(statement.products)}}ç§</text>
            </view>
          </view>
        </view>
        
        <!-- è´¢åŠ¡çŠ¶å†µ -->
        <view class="summary-card finance-card">
          <view class="card-header">
            <view class="card-icon finance-icon">è´¢</view>
            <text class="card-title">è´¢åŠ¡çŠ¶å†µ</text>
          </view>
          <view class="card-content">
            <view class="card-item">
              <text class="item-label">æ€»é‡‘é¢</text>
              <text class="item-value">Â¥{{statement.totalAmount || '0.00'}}</text>
            </view>
            <view class="card-item">
              <text class="item-label">å·²ä»˜æ¬¾</text>
              <text class="item-value highlight-green">Â¥{{statement.totalPayment || '0.00'}}</text>
            </view>
            <view class="card-item">
              <text class="item-label">æœŸæœ«ç»“ä½™</text>
              <text class="item-value {{filter.getBalanceClass(statement.finalBalance)}}">Â¥{{statement.finalBalance || '0.00'}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- æ”¯ä»˜æ˜ç»†æ¨¡å— -->
    <view wx:if="{{statement && !isLoading}}" class="payment-details-section">
      <view class="payment-details-header">
        <view class="payment-details-title-content">
          <view class="payment-details-icon">ğŸ’°</view>
          <view class="payment-details-info">
            <text class="payment-details-title">æ”¯ä»˜æ˜ç»†</text>
            <text class="payment-details-subtitle">ç»“ç®—æ”¯ä»˜æƒ…å†µç»Ÿè®¡</text>
          </view>
        </view>
      </view>
      
      <!-- æ±‡æ€»è¡¨æ ¼ -->
      <view class="payment-details-table">
        <view class="payment-table-header">
          <view class="payment-table-cell header-cell">æ€»é‡‘é¢</view>
          <view class="payment-table-cell header-cell">å·²æ”¯ä»˜</view>
          <view class="payment-table-cell header-cell">ç»“ä½™</view>
        </view>
        <view class="payment-table-row">
          <view class="payment-table-cell data-cell">
            <text class="payment-amount">Â¥{{statement.totalAmount || '0.00'}}</text>
          </view>
          <view class="payment-table-cell data-cell">
            <text class="payment-amount payment-paid">Â¥{{statement.totalPayment || '0.00'}}</text>
          </view>
          <view class="payment-table-cell data-cell">
            <text class="payment-amount {{filter.getBalanceClass(statement.finalBalance)}}">Â¥{{statement.finalBalance || '0.00'}}</text>
          </view>
        </view>
      </view>
      
      <!-- ä»˜æ¬¾è®°å½•æ˜ç»† -->
      <view wx:if="{{statement.paymentRecords && statement.paymentRecords.length > 0}}" class="payment-records-section">
        <view class="payment-records-header">
          <text class="payment-records-title">ä»˜æ¬¾è®°å½•æ˜ç»† ({{statement.paymentRecords.length}}ç¬”)</text>
          <text class="payment-records-subtitle">ä¸å·¥å‚è´¦æˆ·æ˜ç»†åŒæ­¥</text>
        </view>
        
        <view class="payment-records-list">
          <view wx:for="{{statement.paymentRecords}}" wx:key="index" class="payment-record-item">
            <view class="payment-record-header">
              <view class="payment-record-date">{{filter.formatDate(item.date)}}</view>
              <view class="payment-record-amount">Â¥{{item.amount}}</view>
            </view>
            
            <view class="payment-record-body">
              <view class="payment-record-row">
                <view class="payment-record-field">
                  <text class="field-label">å•å·</text>
                  <text class="field-value">{{item.orderNo || '-'}}</text>
                </view>
                <view class="payment-record-field">
                  <text class="field-label">æ”¯ä»˜æ–¹å¼</text>
                  <text class="field-value">{{filter.getPaymentMethodText(item.paymentMethod)}}</text>
                </view>
              </view>
              
              <view class="payment-record-row">
                <view class="payment-record-field">
                  <text class="field-label">çŠ¶æ€</text>
                  <text class="field-value payment-status {{item.status === 'completed' ? 'status-completed' : 'status-pending'}}">
                    {{item.status === 'completed' ? 'å·²å®Œæˆ' : 'å¤„ç†ä¸­'}}
                  </text>
                </view>
                <view class="payment-record-field">
                  <text class="field-label">æ¥æº</text>
                  <text class="field-value payment-source {{item.source === 'account' ? 'source-account' : 'source-receive'}}">
                    {{item.source === 'account' ? 'è´¦æˆ·æ˜ç»†' : 'æ”¶å›å•'}}
                  </text>
                </view>
              </view>
              
              <view class="payment-record-row" wx:if="{{item.remark}}">
                <view class="payment-record-field full-width">
                  <text class="field-label">å¤‡æ³¨</text>
                  <text class="field-value">{{item.remark}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
        
        <view class="payment-records-footer">
          <text class="payment-records-note">ğŸ’¡ ä»˜æ¬¾è®°å½•ä¸å·¥å‚ç®¡ç†ä¸­çš„è´¦æˆ·æ˜ç»†å®æ—¶åŒæ­¥</text>
        </view>
      </view>
      
      <!-- æ— ä»˜æ¬¾è®°å½•æç¤º -->
      <view wx:else class="no-payment-records">
        <view class="no-payment-icon">ğŸ’³</view>
        <text class="no-payment-text">æœ¬æœŸé—´æš‚æ— ä»˜æ¬¾è®°å½•</text>
        <text class="no-payment-hint">å¯åœ¨å·¥å‚ç®¡ç†ä¸­è¿›è¡Œä»˜æ¬¾æ“ä½œ</text>
      </view>
    </view>
    
    <!-- ç°ä»£åŒ–å¯¹è´¦å•æ˜ç»†å¡ç‰‡ -->
    <view class="statement-cards-container">
      <view class="cards-title-section">
        <view class="cards-title-content">
          <view class="cards-title-icon">ğŸ“‹</view>
          <view class="cards-title-info">
            <text class="cards-title">å¯¹è´¦å•æ˜ç»†</text>
            <text class="cards-subtitle">æŒ‰å•å·å±•ç¤ºçš„è¯¦ç»†æ”¶å‘è®°å½•</text>
          </view>
        </view>
        <view class="cards-summary-stats">
          <view class="stat-item">
            <text class="stat-value">{{filter.getArrayLength(statement.orders)}}</text>
            <text class="stat-label">æ˜ç»†æ¡æ•°</text>
          </view>
          <view class="stat-divider"></view>
          <view class="stat-item">
            <text class="stat-value">{{filter.getArrayLength(statement.sendOrders)}}</text>
            <text class="stat-label">å‘å‡ºå•</text>
          </view>
          <view class="stat-divider"></view>
          <view class="stat-item">
            <text class="stat-value">{{filter.getArrayLength(statement.receiveOrders)}}</text>
            <text class="stat-label">æ”¶å›å•</text>
          </view>
        </view>
      </view>
      
      <!-- æ˜ç»†è®°å½•åˆ—è¡¨ -->
      <view wx:if="{{(statement.sendOrders && statement.sendOrders.length > 0) || (statement.receiveOrders && statement.receiveOrders.length > 0)}}" class="statement-details-list">
        <!-- ğŸ”§ ä¿®æ”¹ï¼šå‘å‡ºå•ä¹ŸæŒ‰è¡¨æ ¼æ ¼å¼æ˜¾ç¤ºï¼Œä¸æ”¶å›å•ä¿æŒä¸€è‡´ -->
        <view wx:for="{{statement.sendOrders}}" wx:key="index" class="send-order-group">
        
          <!-- å‘å‡ºå•æ ‡é¢˜è¡Œ -->
          <view class="send-title-row">
            <view class="title-cell">å‘å‡ºå•</view>
            <view class="title-cell">{{item.orderNo || '-'}}</view>
            <view class="title-cell"></view>
            <view class="title-cell">{{item.process || '-'}}</view>
            <view class="title-cell"></view>
            <view class="title-cell">{{filter.formatDate(item.date)}}</view>
          </view>
          
          <!-- è´§å·è´§å“åç§°è¡Œ -->
          <view class="product-info-row">
            <view class="product-info-cell">è´§å·ï¼š{{item.styleNo || item.productNo || '-'}}</view>
            <view class="product-info-cell">è´§å“åç§°ï¼š{{item.productName || '-'}}</view>
            <view class="product-info-cell">å·¥å‚ï¼š{{filter.getFactoryName(selectedFactory)}}</view>
          </view>
          
          <!-- æ˜ç»†è¡¨æ ¼å¤´éƒ¨ -->
          <view class="detail-table-header">
            <view class="detail-header-cell">é¢œè‰²</view>
            <view class="detail-header-cell">å°ºç </view>
            <view class="detail-header-cell">æ•°é‡</view>
            <view class="detail-header-cell">é‡é‡</view>
          </view>
          
          <!-- æ˜ç»†æ•°æ®è¡Œ -->
          <view wx:for="{{item.details}}" wx:key="detailIndex" wx:for-item="detail" class="detail-data-row">
            <view class="detail-data-cell">{{detail.itemColor || detail.color || '-'}}</view>
            <view class="detail-data-cell">{{detail.itemSize || detail.size || '-'}}</view>
            <view class="detail-data-cell">{{detail.itemQuantity || detail.quantity || 0}}</view>
            <view class="detail-data-cell">{{detail.itemWeight || detail.weight || '0'}}</view>
          </view>
          
          <!-- å°è®¡è¡Œ -->
          <view class="subtotal-row">
            <view class="subtotal-cell">å°è®¡</view>
            <view class="subtotal-cell"></view>
            <view class="subtotal-cell">{{item.quantity || 0}}æ‰“</view>
            <view class="subtotal-cell">{{item.weight || '0'}}kg</view>
          </view>
          
          <!-- åˆè®¡æ±‡æ€»è¡Œ - å‘å‡ºå•ä¸æ˜¾ç¤ºæ”¯ä»˜ä¿¡æ¯ -->
          <view class="total-summary-row">
            <view class="summary-label">åˆè®¡ï¼š</view>
            <view class="summary-item">
              <text class="summary-item-label">æ€»é‡é‡</text>
              <text class="summary-item-value">{{item.weight || '0'}}kg</text>
            </view>
            <view class="summary-item">
              <text class="summary-item-label">æ€»æ•°é‡</text>
              <text class="summary-item-value">{{item.quantity || 0}}æ‰“</text>
            </view>
            <view class="summary-item">
              <text class="summary-item-label">å¤‡æ³¨</text>
              <text class="summary-item-value">{{item.remark || '-'}}</text>
            </view>
          </view>
        </view>
        
        <!-- ğŸ”§ æ”¶å›å•æŒ‰è¡¨æ ¼æ ¼å¼æ˜¾ç¤ºï¼ŒåŒå•å·å¤šæ˜ç»† -->
        <view wx:for="{{statement.receiveOrders}}" wx:key="index" class="receive-order-group">
        
          <!-- æ”¶å›å•æ ‡é¢˜è¡Œ -->
          <view class="receive-title-row">
            <view class="title-cell">æ”¶å›å•</view>
            <view class="title-cell">{{item.orderNo || '-'}}</view>
            <view class="title-cell"></view>
            <view class="title-cell">{{item.process || '-'}}</view>
            <view class="title-cell"></view>
            <view class="title-cell">{{filter.formatDate(item.date)}}</view>
          </view>
          
          <!-- è´§å·è´§å“åç§°è¡Œ -->
          <view class="product-info-row">
            <view class="product-info-cell">è´§å·ï¼š{{item.styleNo || item.productNo || '-'}}</view>
            <view class="product-info-cell">è´§å“åç§°ï¼š{{item.productName || '-'}}</view>
            <view class="product-info-cell">å·¥å‚ï¼š{{filter.getFactoryName(selectedFactory)}}</view>
          </view>
          
          <!-- æ˜ç»†è¡¨æ ¼å¤´éƒ¨ -->
          <view class="detail-table-header">
            <view class="detail-header-cell">é¢œè‰²</view>
            <view class="detail-header-cell">å°ºç </view>
            <view class="detail-header-cell">å·¥ä»·</view>
            <view class="detail-header-cell">æ•°é‡</view>
            <view class="detail-header-cell">é‡é‡</view>
            <view class="detail-header-cell">å·¥è´¹</view>
          </view>
          
          <!-- æ˜ç»†æ•°æ®è¡Œ -->
          <view wx:for="{{item.details}}" wx:key="detailIndex" wx:for-item="detail" class="detail-data-row">
            <view class="detail-data-cell">{{detail.itemColor || detail.color || '-'}}</view>
            <view class="detail-data-cell">{{detail.itemSize || detail.size || '-'}}</view>
            <view class="detail-data-cell">{{detail.unitPrice || '0'}}</view>
            <view class="detail-data-cell">{{detail.itemQuantity || detail.quantity || 0}}</view>
            <view class="detail-data-cell">{{detail.itemWeight || detail.weight || '0'}}</view>
            <view class="detail-data-cell">{{detail.fee}}</view>
          </view>
          
          <!-- å°è®¡è¡Œ -->
          <view class="subtotal-row">
            <view class="subtotal-cell">å°è®¡</view>
            <view class="subtotal-cell"></view>
            <view class="subtotal-cell"></view>
            <view class="subtotal-cell">{{item.quantity || 0}}æ‰“</view>
            <view class="subtotal-cell">{{item.weight || '0'}}kg</view>
            <view class="subtotal-cell">{{item.fee || item.totalAmount || '0'}}</view>
          </view>
          
          <!-- åˆè®¡æ±‡æ€»è¡Œ -->
          <view class="total-summary-row">
            <view class="summary-label">åˆè®¡ï¼š</view>
            <view class="summary-item">
              <text class="summary-item-label">æ€»å·¥è´¹</text>
              <text class="summary-item-value">{{item.fee || item.totalAmount || '0'}}</text>
            </view>
            <view class="summary-item">
              <text class="summary-item-label">æ”¯ä»˜é‡‘é¢</text>
              <text class="summary-item-value">{{item.paymentAmount || '0'}}</text>
            </view>
            <view class="summary-item">
              <text class="summary-item-label">æ”¯ä»˜æ–¹å¼</text>
              <text class="summary-item-value">{{filter.getPaymentMethodText(item.paymentMethod) || 'æœªä»˜'}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- ğŸ”§ ä¿®æ”¹æ¡ä»¶ï¼šå½“æ²¡æœ‰å‘å‡ºå•å’Œæ”¶å›å•æ˜ç»†æ•°æ®æ—¶ï¼Œæ˜¾ç¤ºæŒ‰è®¢å•æ±‡æ€»çš„å¡ç‰‡ -->
      <view wx:if="{{(!statement.sendOrders || statement.sendOrders.length === 0) && (!statement.receiveOrders || statement.receiveOrders.length === 0)}}" class="order-cards-wrapper">
        <!-- ç©ºçŠ¶æ€æç¤º -->
        <view class="empty-state">
          <image class="empty-state-image" src="/images/icons/statement.png" mode="aspectFit"></image>
          <text class="empty-state-text">æš‚æ— æ”¶å‘æ˜ç»†æ•°æ®</text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- è´§å“æ±‡æ€»å¡ç‰‡ -->
  <view wx:if="{{statement && !isLoading}}" class="product-summary">
    <view class="product-summary-header">
      <view class="product-summary-title-content">
        <view class="product-summary-icon">ğŸ“¦</view>
        <view class="product-summary-info">
          <text class="summary-title">è´§å“æ±‡æ€»</text>
          <text class="summary-subtitle">æŒ‰è´§å“ç»Ÿè®¡çš„å‘æ”¶æƒ…å†µåŠæŸè€—åˆ†æ</text>
        </view>
      </view>
      <view class="product-count-badge">
        <text>{{filter.getArrayLength(statement.products)}}ç§è´§å“</text>
      </view>
    </view>
    
    <view class="product-cards-wrapper">
      <view wx:for="{{statement.products}}" wx:key="index" class="product-card">
        <view class="product-card-header">
          <view class="product-image-section">
            <!-- ğŸ”§ ä¿®å¤ï¼šæ›´ä¸¥æ ¼çš„å›¾ç‰‡åŠ è½½æ¡ä»¶æ£€æŸ¥ -->
            <image 
              wx:if="{{item.imageUrl && !item.imageLoadFailed && item.imageUrl !== ''}}"
              class="product-card-image" 
              src="{{item.imageUrl}}" 
              mode="aspectFit" 
              binderror="handleImageError" 
              data-index="{{index}}"
            ></image>
            <!-- ğŸ”§ ä¼˜åŒ–ï¼šå›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„å ä½ç¬¦ï¼Œä½¿ç”¨æ›´æ˜ç¡®çš„æ¡ä»¶ -->
            <view wx:else class="product-image-placeholder">
              <text class="placeholder-text">ğŸ“¦</text>
            </view>
          </view>
          <view class="product-basic-info">
            <view class="product-no">{{item.productNo}}</view>
            <view class="product-name">{{item.name}}</view>
            <view class="product-process">{{item.process}}</view>
          </view>
          <view class="product-loss-rate">
            <text class="loss-rate-label">æŸè€—ç‡</text>
            <text class="loss-rate-value {{filter.getLossRateClass(item.lossRate)}}">{{item.lossRate}}%</text>
          </view>
        </view>
        
        <view class="product-card-body">
          <view class="product-stats">
            <view class="stat-section send-stat">
              <text class="stat-title">å‘å‡ºç»Ÿè®¡</text>
              <view class="stat-content">
                <view class="stat-item">
                  <text class="stat-label">æ•°é‡</text>
                  <text class="stat-value highlight-blue">{{item.sendQuantity}}æ‰“</text>
                </view>
                <view class="stat-item">
                  <text class="stat-label">é‡é‡</text>
                  <text class="stat-value highlight-blue">{{item.sendWeight}}kg</text>
                </view>
              </view>
            </view>
            
            <view class="stat-section receive-stat">
              <text class="stat-title">æ”¶å›ç»Ÿè®¡</text>
              <view class="stat-content">
                <view class="stat-item">
                  <text class="stat-label">æ•°é‡</text>
                  <text class="stat-value highlight-orange">{{item.receiveQuantity}}æ‰“</text>
                </view>
                <view class="stat-item">
                  <text class="stat-label">é‡é‡</text>
                  <text class="stat-value highlight-orange">{{item.receiveWeight}}kg</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
  
  <!-- å¯¼å‡ºæŒ‰é’® -->
  <view wx:if="{{statement && !isLoading}}" class="export-section">
    <view class="export-title">å¯¼å‡ºå¯¹è´¦å•</view>
    <view class="export-buttons">
      <button class="export-btn export-image-btn" bindtap="exportAsImage">
        <view class="export-icon">ğŸ“·</view>
        <text>å¯¼å‡ºå›¾ç‰‡</text>
      </button>
      <button class="export-btn export-excel-btn" bindtap="exportAsExcel">
        <view class="export-icon">ğŸ“Š</view>
        <text>å¯¼å‡ºè¡¨æ ¼</text>
      </button>
    </view>
  </view>
  
  <!-- éšè—çš„Canvaså…ƒç´ ç”¨äºç»˜åˆ¶å¯¹è´¦å• -->
  <canvas
    type="2d"
    id="statementCanvas"
    canvas-id="statementCanvas"
    style="width: 400px; height: 700px; position: absolute; left: -9999px; top: -9999px; visibility: hidden;"
    disable-scroll="true"
  />
  
  <!-- è¿”å›æŒ‰é’® -->
  <view class="back-to-send-receive-fixed" bindtap="backToSendReceive">
    <text>è¿”å›</text>
  </view>
  
  <!-- è´¢åŠ¡éªŒè¯çŠ¶æ€æ˜¾ç¤º -->
  <view wx:if="{{statement && statement.financialValidation}}" class="financial-validation-status">
    <view class="validation-header">
      <text class="validation-title">è´¢åŠ¡éªŒè¯çŠ¶æ€</text>
      <button class="help-btn" bindtap="showFinancialHelp" size="mini">
        <text class="help-icon">â“</text>
        <text>å¸®åŠ©</text>
      </button>
    </view>
    
    <view class="validation-content">
      <view class="validation-item">
        <text class="validation-label">éªŒè¯ç»“æœï¼š</text>
        <text class="validation-value {{statement.financialValidation.isValid ? 'success' : 'error'}}">
          {{statement.financialValidation.isValid ? 'âœ“ é€šè¿‡' : 'âœ— æœªé€šè¿‡'}}
        </text>
      </view>
      
      <view class="validation-item">
        <text class="validation-label">é£é™©ç­‰çº§ï¼š</text>
        <text class="validation-value risk-{{statement.financialValidation.riskLevel}}">
          {{statement.financialValidation.riskLevel === 'low' ? 'ğŸŸ¢ ä½é£é™©' : 
            statement.financialValidation.riskLevel === 'medium' ? 'ğŸŸ¡ ä¸­ç­‰é£é™©' :
            statement.financialValidation.riskLevel === 'high' ? 'ğŸŸ  é«˜é£é™©' : 'ğŸ”´ ä¸¥é‡é£é™©'}}
        </text>
      </view>
      
      <view class="validation-item">
        <text class="validation-label">æ£€æŸ¥ç»Ÿè®¡ï¼š</text>
        <text class="validation-value">
          {{statement.financialValidation.summary.totalChecks}}é¡¹æ£€æŸ¥ï¼Œé€šè¿‡ç‡{{statement.financialValidation.summary.successRate}}
        </text>
      </view>
      
      <view wx:if="{{statement.financialValidation.errors.length > 0 || statement.financialValidation.warnings.length > 0}}" class="validation-issues">
        <text wx:if="{{statement.financialValidation.errors.length > 0}}" class="issue-count error">
          {{statement.financialValidation.errors.length}}ä¸ªé”™è¯¯
        </text>
        <text wx:if="{{statement.financialValidation.warnings.length > 0}}" class="issue-count warning">
          {{statement.financialValidation.warnings.length}}ä¸ªè­¦å‘Š
        </text>
        <button class="view-details-btn" bindtap="showFinancialValidationDetails" data-validation="{{statement.financialValidation}}" size="mini">
          æŸ¥çœ‹è¯¦æƒ…
        </button>
      </view>
    </view>
  </view>
</view>