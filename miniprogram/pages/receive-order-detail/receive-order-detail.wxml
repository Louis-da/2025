<view class="container">
  <view class="order-detail" wx:if="{{!loading && order}}">
    <!-- 加载状态 -->
    <view class="loading-container" wx:if="{{loading}}">
      <image class="loading-icon" src="/images/loading.gif"></image>
      <text class="loading-text">加载订单信息中...</text>
    </view>

    <!-- 订单不存在 -->
    <view class="empty-state" wx:elif="{{!order && !loading}}">
      <image class="empty-icon" src="/images/order-not-found.png"></image>
      <view class="empty-text">找不到订单信息</view>
      <button class="btn btn-secondary nav-back-btn-override" bindtap="onNavBack">返回列表</button>
    </view>

    <!-- 在页面的合适位置，例如 <view class="container"> 内部的顶部 -->
    <view wx:if="{{order}}" class="order-basic-info section">
      <view class="info-title">基础信息</view>
      <view class="info-item">
        <text class="label">订单编号:</text>
        <text class="value">{{order.orderNo}}</text>
      </view>
      <view class="info-item">
        <text class="label">工厂名称:</text>
        <text class="value">{{order.factoryName}}</text>
      </view>
      <view class="info-item">
        <text class="label">工艺名称:</text>
        <text class="value">{{order.processName}}</text>
      </view>
      <view class="info-item">
        <text class="label">创建时间:</text>
        <text class="value">{{order.createTime}}</text>
      </view>
      <view class="info-item">
        <text class="label">订单状态:</text>
        <text class="value">{{statusMap[order.status] || order.status}}</text> <!-- 假设您有一个statusMap用于显示中文状态 -->
      </view>
      <!-- 您可以根据需要添加更多基础信息字段 -->
    </view>

    <!-- 订单详情内容 -->
    <block wx:if="{{order && !loading}}">
      <!-- 顶部信息与状态 -->
      <view class="card order-header-card">
        <view class="form-item">
          <text class="form-label">单据号</text>
          <text class="order-no-small-gray">{{order.orderNo}}</text>
        </view>
        <view class="form-item">
          <text class="form-label">状态</text>
          <view class="form-input-static">
            <view class="tag {{order.status === 'pending' ? 'tag-orange' : (order.status === 'completed' ? 'tag-blue' : (order.status === 'paid' ? 'tag-green' : (order.status === 'cancelled' ? 'tag-red' : 'tag-grey')))}}">
              <text wx:if="{{order.status === 'pending'}}">待处理</text>
              <text wx:elif="{{order.status === 'completed'}}">已完成</text>
              <text wx:elif="{{order.status === 'cancelled'}}">已取消</text>
              <text wx:elif="{{order.status === 'paid'}}">已支付</text>
              <text wx:else>未知状态</text>
            </view>
          </view>
        </view>
        <button class="btn btn-secondary btn-icon options-btn-override" bindtap="showOptions">...</button>
      </view>

      <!-- 基本信息 -->
      <view class="card info-section">
        <view class="section-title">基本信息</view>
        <view class="form-item">
          <text class="form-label">加工厂:</text>
          <text class="form-input-static">{{order.factoryName}}</text>
        </view>
        <view class="form-item">
          <text class="form-label">工艺流程:</text>
          <text class="form-input-static">{{order.processName}}</text>
        </view>
        <view class="form-item">
          <text class="form-label">制单人:</text>
          <text class="form-input-static">{{order.creator || order.creatorName || '未知'}}</text>
        </view>
        <view class="form-item">
          <text class="form-label">创建时间:</text>
          <text class="form-input-static">{{order.createTime}}</text>
        </view>
        <view class="form-item">
          <text class="form-label">支付方式:</text>
          <text class="form-input-static">{{order.paymentMethod}}</text>
        </view>
        <view class="form-item" wx:if="{{order.remark}}">
          <text class="form-label">备注信息:</text>
          <text class="form-input-static remark-override">{{order.remark}}</text>
        </view>
        <view class="form-item" wx:if="{{order.remarkImages && order.remarkImages.length > 0}}">
          <text class="form-label">备注照片:</text>
          <view class="remark-photos">
            <image wx:for="{{order.remarkImages}}" wx:key="index" src="{{item}}" mode="aspectFill" class="remark-photo" bindtap="previewRemarkImage" data-index="{{index}}"></image>
          </view>
        </view>
      </view>

      <!-- 产品信息 -->
      <view class="card product-section">
        <view class="section-title">产品信息</view>
        <view class="product-list">
          <view class="card product-item-override" wx:for="{{order.items}}" wx:key="id">
            <view class="product-item-content">
              <image class="product-image" src="{{getFullImageUrl(item.image) || '/images/product-placeholder.png'}}" mode="aspectFill"></image>
              <view class="product-info">
                <view class="product-name">{{item.productName || '未知产品'}} ({{item.productNo || '无货号'}})</view>
                <view class="product-attributes">
                  <view class="attribute">颜色: {{item.color}}</view>
                  <view class="attribute">尺码: {{item.size}}</view>
                </view>
              </view>
              <button class="btn btn-secondary btn-sm edit-btn-override" wx:if="{{canEdit}}" data-id="{{item.id}}" bindtap="editProduct">编辑</button>
            </view>
            <view class="divider"></view>
            <view class="product-details-grid">
              <view class="detail-item">
                <text class="detail-label">单价:</text>
                <text class="detail-value">¥{{item.fee}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">数量:</text>
                <view class="detail-value-container">
                  <text class="detail-value">{{item.quantity}}</text>
                  <text class="detail-unit">打</text>
                </view>
              </view>
              <view class="detail-item">
                <text class="detail-label">重量:</text>
                <view class="detail-value-container">
                  <text class="detail-value">{{item.weight}}</text>
                  <text class="detail-unit">kg</text>
                </view>
              </view>
              <view class="detail-item">
                <text class="detail-label">金额:</text>
                <text class="detail-value price">¥{{(item.quantity || 0) * (item.fee || 0)}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- 订单总计 -->
      <view class="card total-section">
        <view class="section-title">订单总计</view>
        <view class="form-item">
          <text class="form-label">产品总数:</text>
          <view class="form-input-static total-value-container">
            <text class="total-value">{{order.totalQuantity}}</text>
            <text class="total-unit">打</text>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">总重量:</text>
          <view class="form-input-static total-value-container">
            <text class="total-value">{{order.totalWeight}}</text>
            <text class="total-unit">kg</text>
          </view>
        </view>
        <view class="form-item highlight-override">
          <text class="form-label">总金额:</text>
          <text class="form-input-static total-amount-override">¥{{order.totalAmount}}</text>
        </view>
      </view>

      <!-- 明确显示作废订单按钮 - 独立卡片，醒目样式 -->
      <view class="card" style="margin-bottom: 20px; padding: 16px;">
        <button class="btn btn-danger" style="width: 100%; height: 50px; font-size: 18px;" bindtap="cancelOrder">订单作废</button>
      </view>

      <!-- 底部按钮区域 -->
      <view class="footer-actions footer-actions-override">
        <!-- 订单状态为待处理时显示完成按钮 -->
        <block wx:if="{{order.status === 'pending'}}">
          <button class="btn btn-primary action-btn-override" bindtap="completeOrder">完成订单</button>
        </block>
        
        <!-- 订单状态为已完成或normal时显示支付按钮 -->
        <block wx:if="{{order.status === 'completed' || order.status === 'normal'}}">
          <button class="btn btn-primary action-btn-override" bindtap="payOrder">支付订单</button>
        </block>

        <!-- 状态提示信息 -->
        <block wx:if="{{order.status === 'cancelled'}}">
          <view class="no-actions-tip text-secondary">
            该订单已取消，无法执行操作
          </view>
        </block>
        
        <block wx:if="{{order.status === 'paid'}}">
          <view class="no-actions-tip text-secondary">
            该订单已支付完成
          </view>
        </block>
      </view>
    </block>

    <!-- 在您放置操作按钮的区域，例如底部操作栏 -->
    <!-- 假设您有一个底部操作栏 <view class="action-buttons"> -->
  </view>
</view> 